(function(){function g(){this._callbacks=[];this._errCallbacks=[];this._resolved=0;this._result=null}function f(d,a){this.data=d;var c=l,b=a;b||(b={});for(var e in c)b[e]===void 0&&(b[e]=c[e]);this.options=b;this.operation=new g;this.operation.resolve(null,this.data);this.requiredScripts=[];this.requiredFunctions=[]}var h=typeof module!=="undefined"&&module.exports,j=j||function(d){setTimeout(d,0)},i=h?require(__dirname+"/Worker.js"):self.Worker,k=typeof self!=="undefined"?self.URL?self.URL:self.webkitURL:
null;g.prototype.resolve=function(d,a){if(d){this._resolved=2;this._result=d;for(var c=0;c<this._errCallbacks.length;++c)this._errCallbacks[c](a)}else{this._resolved=1;this._result=a;for(c=0;c<this._callbacks.length;++c)this._callbacks[c](a)}this._callbacks=[];this._errCallbacks=[]};g.prototype.then=function(d,a){if(this._resolved===1)d&&d(this._result);else if(this._resolved===2)a&&a(this._result);else return d&&(this._callbacks[this._callbacks.length]=d),a&&(this._errCallbacks[this._errCallbacks.length]=
a),this};var l={evalPath:h?__dirname+"/eval.js":null,maxWorkers:h?require("os").cpus().length:4,synchronous:!0};f.prototype.getWorkerSource=function(d){var a="",c=0;!h&&this.requiredScripts.length!==0&&(a+='importScripts("'+this.requiredScripts.join('","')+'");\r\n');for(c=0;c<this.requiredFunctions.length;++c)a+=this.requiredFunctions[c].name?"var "+this.requiredFunctions[c].name+" = "+this.requiredFunctions[c].fn.toString()+";":this.requiredFunctions[c].fn.toString();return h?a+'process.on("message", function(e) {process.send(JSON.stringify(('+
d.toString()+")(JSON.parse(e).data)))})":a+"self.onmessage = function(e) {self.postMessage(("+d.toString()+")(e.data))}"};f.prototype.require=function(){for(var d=Array.prototype.slice.call(arguments,0),a,c=0;c<d.length;c++)a=d[c],typeof a==="string"?this.requiredScripts.push(a):typeof a==="function"?this.requiredFunctions.push({fn:a}):typeof a==="object"&&this.requiredFunctions.push(a);return this};f.prototype._spawnWorker=function(d){var a,d=this.getWorkerSource(d);if(h)a=new i(this.options.evalPath),
a.postMessage(d);else{if(i===void 0)return;try{if(this.requiredScripts.length!==0)if(this.options.evalPath!==null)a=new i(this.options.evalPath),a.postMessage(d);else throw Error("Can't use required scripts without eval.js!");else if(k){var c=new Blob([d],{type:"text/javascript"}),b=k.createObjectURL(c);a=new i(b)}else throw Error("Can't create a blob URL in this browser!");}catch(e){if(this.options.evalPath!==null)a=new i(this.options.evalPath),a.postMessage(d);else throw e;}}return a};f.prototype.spawn=
function(d){var a=this,c=new g;this.operation.then(function(){var b=a._spawnWorker(d);if(b!==void 0)b.onmessage=function(d){b.terminate();a.data=d.data;c.resolve(null,a.data)},b.postMessage(a.data);else if(a.options.synchronous)j(function(){a.data=d(a.data);c.resolve(null,a.data)});else throw Error("Workers do not exist and synchronous operation not allowed!");});this.operation=c;return this};f.prototype._spawnMapWorker=function(d,a,c){var b=this,e=b._spawnWorker(a);if(e!==void 0)e.onmessage=function(a){e.terminate();
b.data[d]=a.data;c()},e.postMessage(b.data[d]);else if(b.options.synchronous)j(function(){b.data[d]=a(b.data[d]);c()});else throw Error("Workers do not exist and synchronous operation not allowed!");};f.prototype.map=function(d){function a(){++e===c.data.length?f.resolve(null,c.data):b<c.data.length&&c._spawnMapWorker(b++,d,a)}if(!this.data.length)return this.spawn(d);var c=this,b=0,e=0,f=new g;this.operation.then(function(){for(;b-e<c.options.maxWorkers&&b<c.data.length;++b)c._spawnMapWorker(b,d,
a)});this.operation=f;return this};f.prototype._spawnReduceWorker=function(d,a,c){var b=this,e=b._spawnWorker(a);if(e!==void 0)e.onmessage=function(a){e.terminate();b.data[b.data.length]=a.data;c()},e.postMessage(d);else if(b.options.synchronous)j(function(){b.data[b.data.length]=a(d);c()});else throw Error("Workers do not exist and synchronous operation not allowed!");};f.prototype.reduce=function(d){function a(){--c;b.data.length===1&&c===0?(b.data=b.data[0],e.resolve(null,b.data)):b.data.length>
1&&(++c,b._spawnReduceWorker([b.data[0],b.data[1]],d,a),b.data.splice(0,2))}if(!this.data.length)throw Error("Can't reduce non-array data");var c=0,b=this,e=new g;this.operation.then(function(){if(b.data.length===1)e.resolve(null,b.data[0]);else{for(var f=0;f<b.options.maxWorkers&&f<Math.floor(b.data.length/2);++f)++c,b._spawnReduceWorker([b.data[f*2],b.data[f*2+1]],d,a);b.data.splice(0,f*2)}});this.operation=e;return this};f.prototype.then=function(d,a){var c=this,b=new g;this.operation.then(function(){var a=
d(c.data);if(a!==void 0)c.data=a;b.resolve(null,c.data)},a);this.operation=b;return this};h?module.exports=f:self.Parallel=f})();
