/**
*
* HAAR.js Feature Detection Library based on Viola-Jones Haar Detection algorithm
* port of jViolaJones  for Java (http://code.google.com/p/jviolajones/) to JavaScript and Node
*
* https://github.com/foo123/HAAR.js
* @version: 0.4.5
*
* Supports parallel "map-reduce" computation both in browser and node using parallel.js library 
* https://github.com/adambom/parallel.js (included)
*
**/!function(t,e,i,n){i=i?[].concat(i):[];var h,a=i.length,s=new Array(a),r=new Array(a),o=new Array(a);for(h=0;a>h;h++)s[h]=i[h][0],r[h]=i[h][1];if("object"==typeof module&&module.exports){if("undefined"==typeof module.exports[e]){for(h=0;a>h;h++)o[h]=module.exports[s[h]]||require(r[h])[s[h]];module.exports[e]=n.apply(t,o)}}else if("function"==typeof define&&define.amd)define(["exports"].concat(r),function(i){if("undefined"==typeof i[e]){for(var h=Array.prototype.slice.call(arguments,1),a=0,r=h.length;r>a;a++)o[a]=i[s[a]];i[e]=n.apply(t,o)}});else if("undefined"==typeof t[e]){for(h=0;a>h;h++)o[h]=t[s[h]];t[e]=n.apply(t,o)}}(this,"HAAR",null,function(){function t(t,e,i){var n,h,a,s,r,o,l,c=t.length,d=e*i,y=new f(d),g=new u(d),w=new u(d),x=new u(d);for(s=0,a=0,n=h=0;e>s;)l=4899*t[a]+9617*t[a+1]+1868*t[a+2]+8192>>>14,l&=255,n+=l,h+=l*l,y[s]=l,g[s]=n,w[s]=h,x[s]=l,s++,a+=4;for(r=0,o=1,s=e,a=e<<2,n=h=0;c>a;)l=4899*t[a]+9617*t[a+1]+1868*t[a+2]+8192>>>14,l&=255,n+=l,h+=l*l,y[s]=l,g[s]=g[s-e]+n,w[s]=w[s-e]+h,x[s]=x[s+1-e]+(l+y[s-e])+(o>1?x[s-e-e]:0)+(r>0?x[s-1-e]:0),r++,s++,a+=4,r>=e&&(r=0,o++,n=h=0);return{gray:y,integral:g,squares:w,tilted:x}}function e(t,e,i){var n,h,a,s,r,o,l,c,d,g,w,x=t.length,p=new f(x),m=new u(x);for(n=0;e>n;n++)p[n]=0,p[n+e]=0,p[n+x-e]=0,p[n+x-e-e]=0,m[n]=0,m[n+x-e]=0;for(h=0,a=0;i>h;h++,a+=e)p[0+a]=0,p[1+a]=0,p[e-1+a]=0,p[e-2+a]=0,m[0+a]=0,m[e-1+a]=0;for(n=2;e-2>n;n++)for(s=0,h=2,a=e<<1;i-2>h;h++,a+=e)l=n+a,c=l+e,d=c+e,g=l-e,w=g-e,s=0+(t[w-2]<<1)+(t[g-2]<<2)+(t[l-2]<<2)+t[l-2]+(t[c-2]<<2)+(t[d-2]<<1)+(t[w-1]<<2)+(t[g-1]<<3)+t[g-1]+(t[l-1]<<4)-(t[l-1]<<2)+(t[c-1]<<3)+t[c-1]+(t[d-1]<<2)+(t[w]<<2)+t[w]+(t[g]<<4)-(t[g]<<2)+(t[l]<<4)-t[l]+(t[c]<<4)-(t[c]<<2)+(t[d]<<2)+t[d]+(t[w+1]<<2)+(t[g+1]<<3)+t[g+1]+(t[l+1]<<4)-(t[l+1]<<2)+(t[c+1]<<3)+t[c+1]+(t[d+1]<<2)+(t[w+2]<<1)+(t[g+2]<<2)+(t[l+2]<<2)+t[l+2]+(t[c+2]<<2)+(t[d+2]<<1),p[l]=(255&(4294967295&103*s+8192)>>>14)>>>0;for(n=1;e-1>n;n++)for(h=1,a=e;i-1>h;h++,a+=e)l=a+n,c=l+e,g=l-e,r=0-p[g-1]+p[g+1]-p[l-1]-p[l-1]+p[l+1]+p[l+1]-p[c-1]+p[c+1],o=0+p[g-1]+p[g]+p[g]+p[g+1]-p[c-1]-p[c]-p[c]-p[c+1],m[l]=y(r)+y(o);for(n=0,s=0;e>n;)s+=m[n],m[n]=s,n++;for(n=e,a=0,s=0;x>n;)s+=m[n],m[n]=m[n-e]+s,n++,a++,a>=e&&(a=0,s=0);return m}function i(t,e,i){var h,a,s,r,o,l,d,u=t.length,f=new Array(u),y=[],g=0,w=!1;for(s=0;u>s;s++)f[s]=0;for(s=0;u>s;s++){for(w=!1,r=0;s>r;r++)t[r].almostEqual(t[s])&&(w=!0,f[s]=f[r]);w||(f[s]=g,g++)}for(h=new Array(g),a=new Array(g),s=0;g>s;s++)h[s]=0,a[s]=new c;for(s=0;u>s;s++)d=f[s],h[d]++,a[d].add(t[s]);for(s=0;g>s;s++)o=h[s],o>=e&&(l=1/(o+o),d=new c(l*(2*a[s].x+o),l*(2*a[s].y+o),l*(2*a[s].width+o),l*(2*a[s].height+o)),y.push(d));for(1!=i&&(i=1/i),u=y.length,s=0;u>s;s++)for(r=s+1;u>r;r++)!y[s].isInside&&y[s].inside(y[r])?y[s].isInside=!0:!y[r].isInside&&y[r].inside(y[s])&&(y[r].isInside=!0);for(s=u;--s>=0;)y[s].isInside?y.splice(s,1):(1!=i&&y[s].scale(i),y[s].round().computeArea());return y.sort(n)}function n(t,e){return t.area-e.area}function h(t,e){return t.index-e.index}function a(t){return t[1].length&&(t[0]=t[0].concat(t[1]).sort(h)),t[0]}function r(t){var e,i,n,h,a,r,o,l,c,d,u,f,y,g,w,x,p,m,v,S,I,C,A,q,_,H,b,P,R,T,M,L,D,E,j,W,z,k,F,V,O,U,N,B,G,J,K,Q,X,Y=Y||Math.sqrt,Z=[],$=t.haardata,te=t.scaledSelection,ee=te.width,ie=te.height,ne=ee*ie,he=ne-1,ae=$.size1,se=$.size2,re=te.x,oe=te.y,le=$.stages.length,ce=t.cannyLow,de=t.cannyHigh,ue=t.canny,fe=t.integral,ye=t.squares,ge=t.tilted,we=t.scale,xe=t.increment,pe=t.i||0,me=t.doCannyPruning;for(w=0,x=ee-1,p=0,m=ne-ee,n=~~(we*ae),e=~~(n*xe),h=~~(we*se),i=~~(h*xe),c=h*ee,d=i*ee,a=oe*d,xl=ee-n,yl=ie-h,v=n*h,S=1/v,o=oe,l=a;yl>o;o+=i,l+=d)for(r=re;xl>r;r+=e)if(u=r-1+l-ee,f=u+n,y=u+c,g=y+n,u=0>u?0:u>he?he:u,f=0>f?0:f>he?he:f,y=0>y?0:y>he?he:y,g=0>g?0:g>he?he:g,!(me&&(q=S*(ue[g]-ue[y]-ue[f]+ue[u]),ce>q||q>de))){for(I=S*(fe[g]-fe[y]-fe[f]+fe[u]),C=S*(ye[g]-ye[y]-ye[f]+ye[u]),A=C-I*I,A=A>1?Y(A):1,_=!0,s=0;le>s;s++){for(H=$.stages[s],b=H.thres,P=H.trees,R=P.length,X=0,T=0;R>T;T++)for(D=P[T].feats,M=0;;){if(E=D[M],j=E.rects,W=j.length,z=E.thres,k=0,E.tilt)for(F=0;W>F;F++)V=j[F],O=r+~~(we*V[0]),U=(o-1+~~(we*V[1]))*ee,N=r+~~(we*(V[0]+V[2])),B=(o-1+~~(we*(V[1]+V[2])))*ee,G=r+~~(we*(V[0]-V[3])),J=(o-1+~~(we*(V[1]+V[3])))*ee,K=r+~~(we*(V[0]+V[2]-V[3])),Q=(o-1+~~(we*(V[1]+V[2]+V[3])))*ee,O=w>O?w:O>x?x:O,N=w>N?w:N>x?x:N,G=w>G?w:G>x?x:G,K=w>K?w:K>x?x:K,U=p>U?p:U>m?m:U,B=p>B?p:B>m?m:B,J=p>J?p:J>m?m:J,Q=p>Q?p:Q>m?m:Q,k+=V[4]*(ge[K+Q]-ge[G+J]-ge[N+B]+ge[O+U]);else for(F=0;W>F;F++)V=j[F],O=r-1+~~(we*V[0]),N=r-1+~~(we*(V[0]+V[2])),U=ee*(o-1+~~(we*V[1])),B=ee*(o-1+~~(we*(V[1]+V[3]))),O=w>O?w:O>x?x:O,N=w>N?w:N>x?x:N,U=p>U?p:U>m?m:U,B=p>B?p:B>m?m:B,k+=V[4]*(fe[N+B]-fe[O+B]-fe[N+U]+fe[O+U]);if(L=z*A>k*S?0:1){if(E.has_r){X+=E.r_val;break}M=E.r_node}else{if(E.has_l){X+=E.l_val;break}M=E.l_node}}if(_=X>b?!0:!1,!_)break}_&&Z.push({index:pe,x:r,y:o,width:n,height:h})}return Z}function o(t,e){for(var n=0,h=e.length;h>n;n++)e[n]=new c(e[n]);t.objects=i(e,t.min_neighbors,t.Ratio,t.Selection),t.Ready=!0,t.onComplete&&t.onComplete.call(t)}var l,c,d={VERSION:"0.4.5"},u="undefined"!=typeof Float32Array?Float32Array:Array,f="undefined"!=typeof Uint8Array?Uint8Array:Array,y=Math.abs,g=Math.max,w=Math.min,x=(Math.floor,Math.round),p=(Math.sqrt,Array.prototype.slice);return l=d.Detector=function(t,e){this.haardata=t,this.Ready=!1,this.doCannyPruning=!1,this.Canvas=null,this.Selection=null,this.scaledSelection=null,this.objects=null,this.TimeInterval=null,this.DetectInterval=30,this.Ratio=.5,this.cannyLow=20,this.cannyHigh=100,this.Parallel=e||!1,this.onComplete=null},l.prototype={constructor:l,haardata:null,Canvas:null,objects:null,Selection:null,scaledSelection:null,Ratio:.5,origWidth:0,origHeight:0,width:0,height:0,DetectInterval:30,TimeInterval:null,doCannyPruning:!1,cannyLow:20,cannyHigh:100,canny:null,integral:null,squares:null,tilted:null,Parallel:!1,Ready:!1,onComplete:null,clearCache:function(){return this.haardata=null,this.canny=null,this.integral=null,this.squares=null,this.tilted=null,this},cascade:function(t){return this.haardata=t,this},image:function(i,n,h){if(i){var a,s,r,o,l,c,d,u;this.Canvas||(this.Canvas=h||document.createElement("canvas")),u=this.Ratio="undefined"==typeof n?.5:n,this.Ready=!1,o=this.origWidth=i instanceof HTMLVideoElement?i.videoWidth:i.width,l=this.origHeight=i instanceof HTMLVideoElement?i.videoHeight:i.height,c=this.width=this.Canvas.width=x(u*o),d=this.height=this.Canvas.height=x(u*l),a=this.Canvas.getContext("2d"),a.drawImage(i,0,0,o,l,0,0,c,d),s=a.getImageData(0,0,c,d),r=t(s.data,s.width,s.height),this.integral=r.integral,this.squares=r.squares,this.tilted=r.tilted,this.canny=e(r.gray,c,d),r.gray=null,r.integral=null,r.squares=null,r.tilted=null,r=null}return this},interval:function(t){return t>0&&(this.DetectInterval=t),this},cannyThreshold:function(t){return t&&"undefined"!=typeof t.low&&(this.cannyLow=t.low),t&&"undefined"!=typeof t.high&&(this.cannyHigh=t.high),this},selection:function(){var t=p.call(arguments),e=t.length;return this.Selection=1==e&&"auto"==t[0]||!e?null:c.prototype.data.apply(new c,t),this},complete:function(t){return this.onComplete=t,this},detect:function(t,e,i,n,s){var l=this,d=l.haardata.size1,u=l.haardata.size2;if(l.Selection||(l.Selection=new c(0,0,l.origWidth,l.origHeight)),l.Selection.x="auto"==l.Selection.x?0:l.Selection.x,l.Selection.y="auto"==l.Selection.y?0:l.Selection.y,l.Selection.width="auto"==l.Selection.width?l.origWidth:l.Selection.width,l.Selection.height="auto"==l.Selection.height?l.origHeight:l.Selection.height,l.scaledSelection=l.Selection.clone().scale(l.Ratio).round(),t="undefined"==typeof t?1:t,e="undefined"==typeof e?1.25:e,i="undefined"==typeof i?.5:i,n="undefined"==typeof n?1:n,l.doCannyPruning="undefined"==typeof s?!0:s,l.maxScale=w(l.width/d,l.height/u),l.scale=t,l.min_neighbors=n,l.scale_inc=e,l.increment=i,l.Ready=!1,l.Parallel&&l.Parallel.isSupported()){var f,y=[],g=0;for(f=t;f<=l.maxScale;f*=l.scale_inc)y.push({haardata:l.haardata,width:l.width,height:l.height,scaledSelection:{x:l.scaledSelection.x,y:l.scaledSelection.y,width:l.scaledSelection.width,height:l.scaledSelection.height},integral:l.integral,squares:l.squares,tilted:l.tilted,doCannyPruning:l.doCannyPruning,canny:l.doCannyPruning?l.canny:null,cannyLow:l.cannyLow,cannyHigh:l.cannyHigh,maxScale:l.maxScale,min_neighbors:l.min_neighbors,scale_inc:l.scale_inc,increment:l.increment,scale:f,i:g++});new l.Parallel(y,{synchronous:!1}).require(h,r,a).map(r).reduce(a).then(function(t){o(l,t)})}else{var x=[],p=function(){l.scale<=l.maxScale?(x=x.concat(r(l)),l.scale*=l.scale_inc,l.TimeInterval=setTimeout(p,l.DetectInterval)):(clearTimeout(l.TimeInterval),o(l,x))};l.TimeInterval=setTimeout(p,l.DetectInterval)}return this}},c=d.Feature=function(t,e,i,n,h){this.data(t,e,i,n,h)},c.prototype={constructor:c,index:0,x:0,y:0,width:0,height:0,area:0,isInside:!1,data:function(t,e,i,n,h){return t&&t instanceof c?this.copy(t):t&&t instanceof Object?(this.x=t.x||0,this.y=t.y||0,this.width=t.width||0,this.height=t.height||0,this.index=t.index||0,this.area=t.area||0,this.isInside=t.isInside||!1):(this.x=t||0,this.y=e||0,this.width=i||0,this.height=n||0,this.index=h||0,this.area=0,this.isInside=!1),this},add:function(t){return this.x+=t.x,this.y+=t.y,this.width+=t.width,this.height+=t.height,this},scale:function(t){return this.x*=t,this.y*=t,this.width*=t,this.height*=t,this},round:function(){return this.x=~~(this.x+.5),this.y=~~(this.y+.5),this.width=~~(this.width+.5),this.height=~~(this.height+.5),this},computeArea:function(){return this.area=this.width*this.height,this.area},inside:function(t){return this.x>=t.x&&this.y>=t.y&&this.x+this.width<=t.x+t.width&&this.y+this.height<=t.y+t.height?!0:!1},contains:function(t){return t.inside(this)},equal:function(t){return t.x==this.x&&t.y==this.y&&t.width==this.width&&t.height==this.height?!0:!1},almostEqual:function(t){var e=.2*g(t.width,this.width),i=.2*g(t.height,this.height);return y(this.x-t.x)<=e&&y(this.y-t.y)<=i&&y(this.width-t.width)<=e&&y(this.height-t.height)<=i?!0:!1},clone:function(){var t=new c;return t.x=this.x,t.y=this.y,t.width=this.width,t.height=this.height,t.index=this.index,t.area=this.area,t.isInside=this.isInside,t},copy:function(t){return t&&t instanceof c&&(this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.index=t.index,this.area=t.area,this.isInside=t.isInside),this},toString:function(){return"[ x: "+this.x+", y: "+this.y+", width: "+this.width+", height: "+this.height+" ]"}},d});