/**
*
* HAAR.js Feature Detection Library based on Viola-Jones Haar Detection algorithm
* Port of jviolajones (Java) which is a port of openCV C++ Haar Detector
*
* https://github.com/foo123/HAAR.js
* @version: 0.4.2
*
* Supports parallel "map-reduce" computation both in browser and nodejs using parallel.js library 
* https://github.com/adambom/parallel.js (included)
*
**/(function(J){function K(a){var e=a.getContext("2d").getImageData(0,0,a.width,a.height),a=e.width,i=e.height,e=e.data,g=a*i,h,b,j,f,l,d,c=new A(g),k=new v(g),m=new v(g);for(b=0;b<a;b++)for(j=f=g=h=0;j<i;j++)d=f+b,l=d<<2,f+=a,c[d]=4899*e[l]+9617*e[l+1]+1868*e[l+2]+8192>>>14,g+=(c[d]&255)>>>0,h+=(c[d]*c[d]&4294967295)>>>0,b?(k[d]=k[d-1]+g,m[d]=m[d-1]+h):(k[d]=g,m[d]=h);return{gray:c,integral:k,squares:m}}function L(a,e,i){var g,h,b,j=0,f,l,d,c;g=e*i;var k=new A(g),m=new v(g);for(g=0;g<e;g++)for(h=b=
0;h<i;h++)l=b+g,b+=e,g<2||g>=e-2||h<2||h>=i-2?k[l]=0:(f=l+e,j=f+e,d=l-e,c=d-e,j=(0+(a[c-2]<<1)+(a[d-2]<<2)+(a[l-2]<<2)+a[l-2]+(a[f-2]<<2)+(a[j-2]<<1)+(a[c-1]<<2)+(a[d-1]<<3)+a[d-1]+(a[l-1]<<4)-(a[l-1]<<2)+(a[f-1]<<3)+a[f-1]+(a[j-1]<<2)+(a[c]<<2)+a[c]+(a[d]<<4)-(a[d]<<2)+(a[l]<<4)-a[l]+(a[f]<<4)-(a[f]<<2)+(a[j]<<2)+a[j]+(a[c+1]<<2)+(a[d+1]<<3)+a[d+1]+(a[l+1]<<4)-(a[l+1]<<2)+(a[f+1]<<3)+a[f+1]+(a[j+1]<<2)+(a[c+2]<<1)+(a[d+2]<<2)+(a[l+2]<<2)+a[l+2]+(a[f+2]<<2)+(a[j+2]<<1)&4294967295)>>>0,k[l]=((103*
j+8192&4294967295)>>>14&255)>>>0);for(g=0;g<e;g++)for(h=j=b=0;h<i;h++)l=b+g,b+=e,g<1||g>=e-1||h<1||h>=i-1?j=0:(f=l+e,d=l-e,a=0-k[d-1]+k[d+1]-k[l-1]-k[l-1]+k[l+1]+k[l+1]-k[f-1]+k[f+1]&4294967295,f=0+k[d-1]+k[d]+k[d]+k[d+1]-k[f-1]-k[f]-k[f]-k[f+1]&4294967295,j+=o(a)+o(f)),m[l]=g?m[l-1]+j:j;return m}function C(a,e,i,g,h,b,j){var f=f||Math.floor,l=a.haardata.stages[e],e=l.thres,l=l.trees,d=l.length,c=a.integral,a=a.scaledSelection.width,k,m,w,t,n,x,D,s,q,y,u,p,o,r=0;for(k=0;k<d;k++){t=l[k].feats;for(m=
0;;){m=t[m];w=m.rects;n=w.length;x=m.thres;for(s=D=0;s<n;s++)q=w[s],y=i+f(h*q.x1),u=i+f(h*(q.x1+q.y1)),p=a*(g+f(h*q.x2)),o=a*(g+f(h*(q.x2+q.y2))),D+=q.f*(c[u+o]-c[y+o]-c[u+p]+c[y+p]);w=D*j<x*b?0:1;if(0==w)if(m.has_l){r+=m.l_val;break}else m=m.l_node;else if(m.has_r){r+=m.r_val;break}else m=m.r_node}}return r>e}function M(a,e){return a.area-e.area}function E(a,e){return a.index-e.imdex}function F(a){var e=e||Math.floor,i=i||Math.sqrt,g=a.scale,h=a.haardata.size1,b=a.haardata.size2,j=[],f=a.scaledSelection.width,
l=a.scaledSelection.height,d,c,k,m,n,t,o,x,r,s,q=a.cannyLow,y=a.cannyHigh;t=a.scaledSelection.x;var u=a.scaledSelection.y,p;if(g<=a.maxScale){d=e(g*h*a.increment);g=e(g*h);m=g*f;n=d*f;h=1/(g*g);b=e(a.scale*b);e=f*b;b=1/(g*b);for(x=f-g;t<x;t+=d){f=u?u*n:0;o=u;for(r=l-g;o<r;o+=d){c=t+f+m;k=t+f;f+=n;if(a.doCannyPruning&&(c=a.canny[c+g]+a.canny[k]-a.canny[c]-a.canny[k+g],c*=h,c<q||c>y))continue;c=k;s=c+e;k=a.integral[g+s]+a.integral[c]-a.integral[s]-a.integral[g+c];c=a.squares[g+s]+a.squares[c]-a.squares[s]-
a.squares[g+c];k*=b;p=c*b-k*k;p=p>1?i(p):1;k=!0;c=0;for(s=a.haardata.stages.length;c<s;c++)if(k=C(a,c,t,o,a.scale,p,b),k==!1)break;k&&j.push({index:a.i,x:t,y:o,width:g,height:g})}}}return j}function G(a){a[1].length&&(a[0]=a[0].concat(a[1]).sort(E));return a[0]}function H(a,e){var i;i=a.min_neighbors;var g=a.Ratio,h=e.length,b=Array(h),j=[],f=0,l,d;l=!1;var c,k;for(c=0;c<h;c++){b[c]=0;l=!1;e[c]=new n.Feature(e[c]);for(d=0;d<c;d++)e[d].almostEqual(e[c])&&(l=!0,b[c]=b[d]);l||(b[c]=f,f++)}l=Array(f);
d=Array(f);for(c=0;c<f;c++)l[c]=0,d[c]=new n.Feature;for(c=0;c<h;c++)k=b[c],l[k]++,d[k].add(e[c]);for(c=0;c<f;c++)h=l[c],h>=i&&(b=1/(h+h),k=new n.Feature(b*(d[c].x*2+h),b*(d[c].y*2+h),b*(d[c].width*2+h),b*(d[c].height*2+h)),j.push(k));g!=1&&(g=1/g);h=j.length;for(c=0;c<h;c++)for(d=c+1;d<h;d++)if(!j[c].isInside&&j[c].inside(j[d]))j[c].isInside=!0;else if(!j[d].isInside&&j[d].inside(j[c]))j[d].isInside=!0;for(c=h;--c>=0;)j[c].isInside?j.splice(c,1):(g!=1&&j[c].scale(g),j[c].round().computeArea());i=
j.sort(M);a.objects=i;a.ret=null;a.Ready=!0;a.onComplete&&a.onComplete.call(a)}var n;n="undefined"!=typeof module&&module.exports?module.exports:"undefined"!=typeof exports?exports:J.HAAR={};var A=typeof Uint8Array!=="undefined"?Uint8Array:Array,v=typeof Uint32Array!=="undefined"?Uint32Array:Array,o=Math.abs,I=Math.max,N=Math.min,r=Math.round,O=Math.sqrt;n.Feature=function(a,e,i,g,h){this.data(a,e,i,g,h)};n.Feature.prototype={index:0,x:0,y:0,width:0,height:0,area:0,isInside:!1,data:function(a,e,i,
g,h){a&&a instanceof n.Feature?a.clone(this):a&&a instanceof Object?(this.x=a.x||0,this.y=a.y||0,this.width=a.width||0,this.height=a.height||0,this.index=a.index||0,this.area=a.area||0,this.isInside=a.isInside||!1):(this.x=a||0,this.y=e||0,this.width=i||0,this.height=g||0,this.index=h||0,this.area=0,this.isInside=!1);return this},add:function(a){this.x+=a.x;this.y+=a.y;this.width+=a.width;this.height+=a.height;return this},scale:function(a){this.x*=a;this.y*=a;this.width*=a;this.height*=a;return this},
round:function(){this.x=r(this.x);this.y=r(this.y);this.width=r(this.width);this.height=r(this.height);return this},computeArea:function(){return this.area=this.width*this.height},inside:function(a){return this.x>=a.x&&this.y>=a.y&&this.x+this.width<=a.x+a.width&&this.y+this.height<=a.y+a.height?!0:!1},contains:function(a){return a.inside(this)},equal:function(a){return a.x==this.x&&a.y==this.y&&a.width==this.width&&(a.height=this.height)?!0:!1},almostEqual:function(a){var e=I(a.width,this.width)*
0.18,i=I(a.height,this.height)*0.18;return o(this.x-a.x)<=e&&o(this.y-a.y)<=i&&o(this.width-a.width)<=e&&o(this.height-a.height)<=i?!0:!1},clone:function(a){a=a||new n.Feature;a.x=this.x;a.y=this.y;a.width=this.width;a.height=this.height;a.index=this.index;a.area=this.area;a.isInside=this.isInside;return a}};n.Detector=function(a,e){this.haardata=a;this.doCannyPruning=this.Ready=!1;this.TimeInterval=this.objects=this.scaledSelection=this.Selection=this.ret=this.Canvas=null;this.DetectInterval=30;
this.Ratio=0.5;this.ImageChanged=!1;this.cannyLow=20;this.cannyHigh=100;this.Parallel=e||!1;this.onComplete=null};n.Detector.prototype={haardata:null,objects:null,Selection:null,Ready:!1,cascade:function(a){this.haardata=a;return this},image:function(a,e,i){if(a)this.Canvas=i||document.createElement("canvas"),this.Ratio=typeof e=="undefined"?0.5:e,this.Async=!0,this.Ready=!1,this.origWidth=a.width,this.origHeight=a.height,this.width=this.Canvas.width=r(this.Ratio*a.width),this.height=this.Canvas.height=
r(this.Ratio*a.height),this.Canvas.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,this.width,this.height),this.ImageChanged=!0;return this},interval:function(a){if(a>0)this.DetectInterval=a;return this},cannyThreshold:function(a){a&&"undefined"!=typeof a.low&&(this.cannyLow=a.low);a&&"undefined"!=typeof a.high&&(this.cannyHigh=a.high);return this},selection:function(){var a=Array.prototype.slice.call(arguments);this.Selection=1==a.length&&"auto"==a[0]||!a.length?null:n.Feature.prototype.data.apply(new n.Feature,
a);return this},complete:function(a){this.onComplete=a;return this},detect:function(a,e,i,g,h){var b=this,j=b.haardata.size1,f=b.haardata.size2;if(!b.Selection)b.Selection=new n.Feature(0,0,b.origWidth,b.origHeight);b.Selection.x="auto"==b.Selection.x?0:b.Selection.x;b.Selection.y="auto"==b.Selection.y?0:b.Selection.y;b.Selection.width="auto"==b.Selection.width?b.origWidth:b.Selection.width;b.Selection.height="auto"==b.Selection.height?b.origHeight:b.Selection.height;b.scaledSelection=b.Selection.clone().scale(b.Ratio).round();
a=typeof a=="undefined"?1:a;e=typeof e=="undefined"?1.25:e;i=typeof i=="undefined"?0.1:i;g=typeof g=="undefined"?1:g;b.doCannyPruning=typeof h=="undefined"?!0:h;if(b.ImageChanged)h=K(b.Canvas),b.canny=b.doCannyPruning?L(h.gray,b.width,b.height):null,b.integral=h.integral,b.squares=h.squares,h=null;b.ImageChanged=!1;b.maxScale=N(b.width/j,b.height/f);b.scale=a;b.min_neighbors=g;b.scale_inc=e;b.increment=i;b.Ready=!1;if(b.Parallel&&b.Parallel.isSupported()){j=[];for(f=0;a<=b.maxScale;a*=e)j.push({haardata:b.haardata,
width:b.width,height:b.height,scaledSelection:{x:b.scaledSelection.x,y:b.scaledSelection.y,width:b.scaledSelection.width,height:b.scaledSelection.height},integral:b.integral,squares:b.squares,doCannyPruning:b.doCannyPruning,canny:b.canny,cannyLow:b.cannyLow,cannyHigh:b.cannyHigh,maxScale:b.maxScale,min_neighbors:g,scale_inc:e,increment:i,scale:a,i:f++});(new b.Parallel(j,{synchronous:!1})).require(E,C,F,G).map(F).reduce(G).then(function(a){H(b,a)})}else b.ret=[],b.TimeInterval=setInterval(function(){var a=
a||Math.floor,d=b.haardata.size1,c=b.haardata.size2,e=b.scaledSelection.width,g=b.scaledSelection.height,h,f,j,i,n,o,q,r,u,p,v=b.cannyLow,A=b.cannyHigh,B,z;if(b.scale<=b.maxScale){h=a(b.scale*d*b.increment);d=a(b.scale*d);n=d*e;o=h*e;j=1/(d*d);c=a(b.scale*c);a=e*c;B=1/(d*c);c=0;for(r=e-d;c<r;c+=h){q=e=0;for(u=g-d;q<u;q+=h){f=c+e+n;i=c+e;e+=o;if(b.doCannyPruning&&(f=b.canny[f+d]+b.canny[i]-b.canny[f]-b.canny[i+d],f*=j,f<v||f>A))continue;f=i;p=f+a;i=b.integral[d+p]+b.integral[f]-b.integral[p]-b.integral[d+
f];f=b.squares[d+p]+b.squares[f]-b.squares[p]-b.squares[d+f];i*=B;z=f*B-i*i;z=z>1?O(z):1;i=!0;f=0;for(p=b.haardata.stages.length;f<p;f++)if(i=C(b,f,c,q,b.scale,z,B),i==!1)break;i&&b.ret.push({x:c,y:q,width:d,height:d})}}b.scale*=b.scale_inc}else clearInterval(b.TimeInterval),H(b,b.ret)},b.DetectInterval);return this}}})(this);
