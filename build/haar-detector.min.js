/**
*
* HAAR.js Feature Detection Library based on Viola-Jones Haar Detection algorithm
* Port of jviolajones (Java) which is a port of openCV C++ Haar Detector
*
* https://github.com/foo123/HAAR.js
* @version: 0.4
*
* Supports parallel "map-reduce" computation both in browser and nodejs using parallel.js library 
* https://github.com/adambom/parallel.js (included)
*
**/(function(J){function K(a,h){var i=a.getContext("2d").getImageData(h.x,h.y,h.width,h.height),g=i.width,l=i.height,i=i.data,b=g*l,j,d,k,f,e,c,m=new B(b),o=new x(b),p=new x(b);for(d=0;d<g;d++)for(k=f=b=j=0;k<l;k++)c=f+d,e=c<<2,f+=g,m[c]=4899*i[e]+9617*i[e+1]+1868*i[e+2]+8192>>>14,b+=(m[c]&255)>>>0,j+=(m[c]*m[c]&4294967295)>>>0,d?(o[c]=o[c-1]+b,p[c]=p[c-1]+j):(o[c]=b,p[c]=j);return{gray:m,integral:o,squares:p}}function L(a,h,i){var g,l,b,j=0,d,k,f,e;g=h*i;var c=new B(g),m=new x(g);for(g=0;g<h;g++)for(l=
b=0;l<i;l++)k=b+g,b+=h,g<2||g>=h-2||l<2||l>=i-2?c[k]=0:(d=k+h,j=d+h,f=k-h,e=f-h,j=(0+(a[e-2]<<1)+(a[f-2]<<2)+(a[k-2]<<2)+a[k-2]+(a[d-2]<<2)+(a[j-2]<<1)+(a[e-1]<<2)+(a[f-1]<<3)+a[f-1]+(a[k-1]<<4)-(a[k-1]<<2)+(a[d-1]<<3)+a[d-1]+(a[j-1]<<2)+(a[e]<<2)+a[e]+(a[f]<<4)-(a[f]<<2)+(a[k]<<4)-a[k]+(a[d]<<4)-(a[d]<<2)+(a[j]<<2)+a[j]+(a[e+1]<<2)+(a[f+1]<<3)+a[f+1]+(a[k+1]<<4)-(a[k+1]<<2)+(a[d+1]<<3)+a[d+1]+(a[j+1]<<2)+(a[e+2]<<1)+(a[f+2]<<2)+(a[k+2]<<2)+a[k+2]+(a[d+2]<<2)+(a[j+2]<<1)&4294967295)>>>0,c[k]=((103*
j+8192&4294967295)>>>14&255)>>>0);for(g=0;g<h;g++)for(l=j=b=0;l<i;l++)k=b+g,b+=h,g<1||g>=h-1||l<1||l>=i-1?j=0:(d=k+h,f=k-h,a=0-c[f-1]+c[f+1]-c[k-1]-c[k-1]+c[k+1]+c[k+1]-c[d-1]+c[d+1]&4294967295,d=0+c[f-1]+c[f]+c[f]+c[f+1]-c[d-1]-c[d]-c[d]-c[d+1]&4294967295,j+=q(a)+q(d)),m[k]=g?m[k-1]+j:j;return m}function M(a,h){return a.area-h.area}function C(a,h){return a.index-h.imdex}function D(a){var h=h||Math.floor,i=i||Math.sqrt,g=a.scale,l=a.haardata.size1,b=a.haardata.size2,j=[],d=a.scaledSelection.width,
k=a.scaledSelection.height,f,e,c,m,o,p,n,u,r,q=a.cannyLow,N=a.cannyHigh,v,s;if(g<=a.maxScale){f=h(g*l*a.increment);g=h(g*l);m=g*d;o=f*d;l=1/(g*g);b=h(a.scale*b);h=d*b;v=1/(g*b);b=0;for(n=d-g;b<n;b+=f){p=d=0;for(u=k-g;p<u;p+=f){e=b+d+m;c=b+d;d+=o;if(a.doCannyPruning&&(e=a.canny[e+g]+a.canny[c]-a.canny[e]-a.canny[c+g],e*=l,e<q||e>N))continue;e=c;r=e+h;c=a.integral[g+r]+a.integral[e]-a.integral[r]-a.integral[g+e];e=a.squares[g+r]+a.squares[e]-a.squares[r]-a.squares[g+e];c*=v;s=e*v-c*c;s=s>1?i(s):1;c=
!0;e=0;for(r=a.haardata.stages.length;e<r;e++)if(c=A(a,e,b,p,a.scale,s,v),c==!1)break;c&&j.push({index:a.i,x:b,y:p,width:g,height:g})}}}return j}function E(a){a[1].length&&(a[0]=a[0].concat(a[1]).sort(C));return a[0]}function F(a,h){var i;i=a.min_neighbors;var g=a.Ratio,l=a.Selection,b=h.length,j=Array(b),d=[],k=0,f,e;f=!1;var c,m;for(c=0;c<b;c++){j[c]=0;f=!1;h[c]=new n.Feature(h[c]);for(e=0;e<c;e++)h[e].almostEqual(h[c])&&(f=!0,j[c]=j[e]);f||(j[c]=k,k++)}f=Array(k);e=Array(k);for(c=0;c<k;c++)f[c]=
0,e[c]=new n.Feature;for(c=0;c<b;c++)m=j[c],f[m]++,e[m].add(h[c]);for(c=0;c<k;c++)b=f[c],b>=i&&(j=1/(b+b),m=new n.Feature(j*(e[c].x*2+b),j*(e[c].y*2+b),j*(e[c].width*2+b),j*(e[c].height*2+b)),d.push(m));g!=1&&(g=1/g);b=d.length;for(c=0;c<b;c++)for(e=c+1;e<b;e++)if(!d[c].isInside&&d[c].inside(d[e]))d[c].isInside=!0;else if(!d[e].isInside&&d[e].inside(d[c]))d[e].isInside=!0;for(c=b;--c>=0;)d[c].isInside?d.splice(c,1):(g!=1&&d[c].scale(g),d[c].x+=l.x,d[c].y+=l.y,d[c].round().computeArea());i=d.sort(M);
a.objects=i;a.ret=null;a.Ready=!0;a.onComplete&&a.onComplete.call(a)}function A(a,h,i,g,l,b,j){var d=0,k=a.haardata.stages[h].thres,f,e=a.haardata.stages[h].trees.length;for(f=0;f<e;f++)d+=G(a,h,f,i,g,l,b,j);return d>k}function G(a,h,i,g,l,b,j,d){for(var k=a.haardata.stages[h].trees[i].feats,f=0,e=k[0];;)if(f=H(a,h,i,f,g,l,b,j,d),0==f)if(e.has_l)return e.l_val;else f=e.l_node,e=k[f];else if(e.has_r)return e.r_val;else f=e.r_node,e=k[f]}function H(a,h,i,g,l,b,j,d,k){var f=f||Math.floor,e=a.integral,
g=a.haardata.stages[h].trees[i].feats[g],h=g.rects,i=h.length,g=g.thres,a=a.scaledSelection.width,c=0,m,o,p,n,u,r;for(m=0;m<i;m++)o=h[m],p=l+f(j*o.x1),n=l+f(j*(o.x1+o.y1)),u=b+f(j*o.x2),r=b+f(j*(o.x2+o.y2)),u*=a,r*=a,c+=o.f*(e[n+r]-e[p+r]-e[n+u]+e[p+u]);return c*k<g*d?0:1}var n;n="undefined"!=typeof module&&module.exports?module.exports:"undefined"!=typeof exports?exports:J.HAAR={};var B=typeof Uint8Array!=="undefined"?Uint8Array:Array,x=typeof Uint32Array!=="undefined"?Uint32Array:Array,q=Math.abs,
I=Math.max,O=Math.min,t=Math.round,P=Math.sqrt;n.Feature=function(a,h,i,g,l){this.data(a,h,i,g,l)};n.Feature.prototype={index:0,x:0,y:0,width:0,height:0,area:0,isInside:!1,data:function(a,h,i,g,l){a&&a instanceof n.Feature?a.clone(this):a&&a instanceof Object?(this.x=a.x||0,this.y=a.y||0,this.width=a.width||0,this.height=a.height||0,this.index=a.index||0,this.area=a.area||0,this.isInside=a.isInside||!1):(this.x=a||0,this.y=h||0,this.width=i||0,this.height=g||0,this.index=l||0,this.area=0,this.isInside=
!1);return this},add:function(a){this.x+=a.x;this.y+=a.y;this.width+=a.width;this.height+=a.height;return this},scale:function(a){this.x*=a;this.y*=a;this.width*=a;this.height*=a;return this},round:function(){this.x=t(this.x);this.y=t(this.y);this.width=t(this.width);this.height=t(this.height);return this},computeArea:function(){return this.area=this.width*this.height},inside:function(a){return this.x>=a.x&&this.y>=a.y&&this.x+this.width<=a.x+a.width&&this.y+this.height<=a.y+a.height?!0:!1},contains:function(a){return a.inside(this)},
equal:function(a){return a.x==this.x&&a.y==this.y&&a.width==this.width&&(a.height=this.height)?!0:!1},almostEqual:function(a){var h=I(a.width,this.width)*0.18,i=I(a.height,this.height)*0.18;return q(this.x-a.x)<=h&&q(this.y-a.y)<=i&&q(this.width-a.width)<=h&&q(this.height-a.height)<=i?!0:!1},clone:function(a){a=a||new n.Feature;a.x=this.x;a.y=this.y;a.width=this.width;a.height=this.height;a.index=this.index;a.area=this.area;a.isInside=this.isInside;return a}};n.Detector=function(a,h){this.haardata=
a;this.doCannyPruning=this.Ready=!1;this.TimeInterval=this.objects=this.scaledSelection=this.Selection=this.ret=this.Canvas=null;this.DetectInterval=30;this.Ratio=0.5;this.cannyLow=20;this.cannyHigh=100;this.Parallel=h||!1;this.onComplete=null};n.Detector.prototype={haardata:null,objects:null,Selection:null,Ready:!1,image:function(a,h,i){if(a)this.Canvas=i||document.createElement("canvas"),this.Ratio=typeof h=="undefined"?0.5:h,this.Async=!0,this.Ready=!1,this.origWidth=a.width,this.origHeight=a.height,
this.width=this.Canvas.width=t(this.Ratio*a.width),this.height=this.Canvas.height=t(this.Ratio*a.height),this.Canvas.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,this.width,this.height);return this},interval:function(a){if(a>0)this.DetectInterval=a;return this},cannyThreshold:function(a){a&&"undefined"!=typeof a.low&&(this.cannyLow=a.low);a&&"undefined"!=typeof a.high&&(this.cannyHigh=a.high);return this},selection:function(){var a=Array.prototype.slice.call(arguments);this.Selection=1==
a.length&&"auto"==a[0]||!a.length?null:n.Feature.prototype.data.apply(new n.Feature,a);return this},complete:function(a){this.onComplete=a;return this},detect:function(a,h,i,g,l){var b=this,j=b.haardata.size1,d=b.haardata.size2;if(!b.Selection)b.Selection=new n.Feature(0,0,b.origWidth,b.origHeight);b.Selection.x="auto"==b.Selection.x?0:b.Selection.x;b.Selection.y="auto"==b.Selection.y?0:b.Selection.y;b.Selection.width="auto"==b.Selection.width?b.origWidth:b.Selection.width;b.Selection.height="auto"==
b.Selection.height?b.origHeight:b.Selection.height;b.scaledSelection=b.Selection.clone().scale(b.Ratio).round();a=typeof a=="undefined"?1:a;h=typeof h=="undefined"?1.25:h;i=typeof i=="undefined"?0.1:i;g=typeof g=="undefined"?1:g;b.doCannyPruning=typeof l=="undefined"?!0:l;l=K(b.Canvas,b.scaledSelection);b.canny=b.doCannyPruning?L(l.gray,b.scaledSelection.width,b.scaledSelection.height):null;b.integral=l.integral;b.squares=l.squares;l=null;b.maxScale=O(b.width/j,b.height/d);b.scale=a;b.min_neighbors=
g;b.scale_inc=h;b.increment=i;b.Ready=!1;if(b.Parallel&&b.Parallel.isSupported()){j=[];for(d=0;a<=b.maxScale;a*=h)j.push({haardata:b.haardata,width:b.width,height:b.height,scaledSelection:{x:b.scaledSelection.x,y:b.scaledSelection.y,width:b.scaledSelection.width,height:b.scaledSelection.height},integral:b.integral,squares:b.squares,doCannyPruning:b.doCannyPruning,canny:b.canny,cannyLow:b.cannyLow,cannyHigh:b.cannyHigh,maxScale:b.maxScale,min_neighbors:g,scale_inc:h,increment:i,scale:a,i:d++});(new b.Parallel(j,
{synchronous:!1})).require(C,A,G,H,D,E).map(D).reduce(E).then(function(a){F(b,a)})}else b.ret=[],b.TimeInterval=setInterval(function(){var a=a||Math.floor,f=b.haardata.size1,e=b.haardata.size2,c=b.scaledSelection.width,h=b.scaledSelection.height,g,d,j,i,l,n,q,v,s,w,t=b.cannyLow,x=b.cannyHigh,z,y;if(b.scale<=b.maxScale){g=a(b.scale*f*b.increment);f=a(b.scale*f);l=f*c;n=g*c;j=1/(f*f);e=a(b.scale*e);a=c*e;z=1/(f*e);e=0;for(v=c-f;e<v;e+=g){q=c=0;for(s=h-f;q<s;q+=g){d=e+c+l;i=e+c;c+=n;if(b.doCannyPruning&&
(d=b.canny[d+f]+b.canny[i]-b.canny[d]-b.canny[i+f],d*=j,d<t||d>x))continue;d=i;w=d+a;i=b.integral[f+w]+b.integral[d]-b.integral[w]-b.integral[f+d];d=b.squares[f+w]+b.squares[d]-b.squares[w]-b.squares[f+d];i*=z;y=d*z-i*i;y=y>1?P(y):1;i=!0;d=0;for(w=b.haardata.stages.length;d<w;d++)if(i=A(b,d,e,q,b.scale,y,z),i==!1)break;i&&b.ret.push({x:e,y:q,width:f,height:f})}}b.scale*=b.scale_inc}else clearInterval(b.TimeInterval),F(b,b.ret)},b.DetectInterval);return this}}})(this);
