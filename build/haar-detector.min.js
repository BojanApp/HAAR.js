/**
*
* HAAR.js Feature Detection Library based on Viola-Jones Haar Detection algorithm
* Port of jviolajones (Java) which is a port of openCV C++ Haar Detector
*
* Supports parallel "map-reduce" computation both in browser and nodejs (using parallel.js library)
*
* version: 0.3
* https://github.com/foo123/HAAR.js
*
*
* @contributor Nikos M.  (http://nikos-web-development.netai.net/)
* @contributor maxired (https://github.com/maxired)
*
**/
(function(p){function x(d,e){var a=e.getContext("2d").getImageData(0,0,e.width,e.height),j=a.width,b=a.height,f,l,c,g,h,k,a=a.data;f=j*b;d.width=j;d.height=b;d.gray=new q(f);d.img=new y(f);d.squares=new q(f);for(c=0;c<j;c++)for(g=l=f=0;g<b;g++)ind=g*j+c,h=ind*4,red=a[h],green=a[h+1],blue=a[h+2],h=0.3*red+0.59*green+0.11*blue,k=h*h,f+=h,l+=k,d.img[ind]=h,d.gray[ind]=(c>0?d.gray[c-1+g*j]:0)+f,d.squares[ind]=(c>0?d.squares[c-1+g*j]:0)+l}function z(d,e){var a,j,b,f=d.width,l=d.height,c,g,h,k;a=f*l;var i=
new q(a),m=new q(a);for(a=2;a<f-2;a++)for(j=2;j<l-2;j++)g=j*f,c=g+f,h=c+f,ind_1=g-f,k=ind_1-f,b=0,b+=2*e[a-2+k],b+=4*e[a-2+ind_1],b+=5*e[a-2+g],b+=4*e[a-2+c],b+=2*e[a-2+h],b+=4*e[a-1+k],b+=9*e[a-1+ind_1],b+=12*e[a-1+g],b+=9*e[a-1+c],b+=4*e[a-1+h],b+=5*e[a+0+k],b+=12*e[a+0+ind_1],b+=15*e[a+0+g],b+=12*e[a+0+c],b+=5*e[a+0+h],b+=4*e[a+1+k],b+=9*e[a+1+ind_1],b+=12*e[a+1+g],b+=9*e[a+1+c],b+=4*e[a+1+h],b+=2*e[a+2+k],b+=4*e[a+2+ind_1],b+=5*e[a+2+g],b+=4*e[a+2+c],b+=2*e[a+2+h],i[a+g]=b/159;for(a=1;a<f-1;a++)for(j=
1;j<l-1;j++)g=j*f,c=g+f,ind_1=g-f,b=-i[a-1+ind_1]+i[a+1+ind_1]-2*i[a-1+g]+2*i[a+1+g]-i[a-1+c]+i[a+1+c],c=i[a-1+ind_1]+2*i[a+ind_1]+i[a+1+ind_1]-i[a-1+c]-2*i[a+c]-i[a+1+c],m[a+g]=Math.abs(b)+Math.abs(c);for(a=0;a<f;a++)for(j=c=0;j<l;j++)g=j*f,b=m[a+g],c+=b,i[a+g]=(a>0?i[a-1+g]:0)+c;return i}function s(d,e,a){for(var j=e.length,b=Array(j),f=0,l=[],c=!1,g,c=0;c<j;c++)b[c]=0;for(var h=0;h<j;h++){c=!1;for(g=0;g<h;g++){var k;k=e[g];var i=e[h],m=Math.max(Math.floor(k.width*0.2),Math.floor(i.width*0.2));
k=i.x<=k.x+m&&i.x>=k.x-m&&i.y<=k.y+m&&i.y>=k.y-m&&i.width<=Math.floor(k.width*1.2)&&Math.floor(i.width*1.2)>=k.width?!0:k.x>=i.x&&k.x+k.width<=i.x+i.width&&k.y>=i.y&&k.y+k.height<=i.y+i.height?!0:!1;k&&(c=!0,b[h]=b[g])}c||(b[h]=f,f++)}j=Array(f);g=Array(f);for(h=0;h<f;h++)j[h]=0,g[h]={x:0,y:0,width:0,height:0};for(h=0;h<e.length;h++)j[b[h]]++,g[b[h]].x+=e[h].x,g[b[h]].y+=e[h].y,g[b[h]].height+=e[h].height,g[b[h]].width+=e[h].width;for(h=0;h<f;h++)if(e=j[h],e>=a)c={x:0,y:0,width:0,height:0},c.x=(g[h].x*
2+e)/(2*e),c.y=(g[h].y*2+e)/(2*e),c.width=(g[h].width*2+e)/(2*e),c.height=(g[h].height*2+e)/(2*e),l.push(c);if(d.ratio!=1){d=1/d.ratio;for(h=0;h<l.length;h++)a=l[h],l[h]={x:a.x*d,y:a.y*d,width:a.width*d,height:a.height*d}}return l}function t(d){var e=d.scale,a=d.haardata.size1,j=[],b=d.width,f=d.height,l,c,g;if(e<=d.maxScale){l=Math.floor(e*a*d.increment);for(var a=Math.floor(e*a),h=0,k=b-a;h<k;h+=l)for(var i=0,m=f-a;i<m;i+=l){if(d.doCannyPruning&&(c=h+(i+a)*b,g=h+i*b,c=d.canny[c+a]+d.canny[g]-d.canny[c]-
d.canny[g+a],c=c/a/a,c<20||c>100))continue;c=!0;g=0;for(var o=d.haardata.stages.length;g<o;g++)if(c=r(d,g,h,i,e),c==!1)break;c&&j.push({x:h,y:i,width:a,height:a})}}return j}function u(d){return d[0].concat(d[1])}function r(d,e,a,j,b){var f=0,l=d.haardata.stages[e].thres,c,g=d.haardata.stages[e].trees.length;for(c=0;c<g;c++)f+=v(d,e,c,a,j,b);return f>l}function v(d,e,a,j,b,f){for(var l=d.haardata.stages[e].trees[a].feats,c=0,g=l[c];;)if(w(d,e,a,c,j,b,f)==0)if(g.has_l)return g.l_val;else c=g.l_node,
g=l[c];else if(g.has_r)return g.r_val;else c=g.r_node,g=l[c]}function w(d,e,a,j,b,f,l){for(var c=Math.floor(l*d.haardata.size1),g=Math.floor(l*d.haardata.size2),h=d.width,k=1/(c*g),i=f*h,m=(f+g)*h,g=d.gray,o=d.squares,n=(g[b+c+m]+g[b+i]-g[b+m]-g[b+c+i])*k,c=(o[b+c+m]+o[b+i]-o[b+m]-o[b+c+i])*k-n*n,a=d.haardata.stages[e].trees[a].feats[j],d=a.rects,e=d.length,a=a.thres,c=c>1?Math.sqrt(c):1,i=j=0;i<e;i++){var m=d[i],o=b+Math.floor(l*m.x1),n=b+Math.floor(l*(m.x1+m.y1)),p=f+Math.floor(l*m.x2),q=f+Math.floor(l*
(m.x2+m.y2));j+=Math.floor((g[n+q*h]-g[o+q*h]-g[n+p*h]+g[o+p*h])*m.f)}return j*k<a*c?0:1}var p="undefined"!=typeof module&&module.exports?module.exports:"undefined"!=typeof exports?exports:p.HAAR={},y=typeof Float32Array!=="undefined"?Float32Array:Array,q=typeof Float64Array!=="undefined"?Float64Array:Array;p.Detector=function(d,e){this.haardata=d;this.async=!0;this.canvas=this.Image=null;this._interval=30;this.Parallel=e||!1;this.onComplete=null};p.Detector.prototype={image:function(d,e,a){this.Image=
d;this.canvas=a||document.createElement("canvas");typeof e=="undefined"&&(e=0.5);this.ratio=e;this.async=!0;this.canvas.width=e*d.width;this.canvas.height=e*d.height;this.canvas.getContext("2d").drawImage(d,0,0,d.width,d.height,0,0,e*d.width,e*d.height);return this},complete:function(d){this.onComplete=d;return this},interval:function(d){this._interval=d;return this},detect:function(d,e,a,j,b){typeof b=="undefined"&&(b=!0);this.doCannyPruning=b;this.ret=[];x(this,this.canvas);var f=this;this.maxScale=
Math.min(this.width/this.haardata.size1,this.height/this.haardata.size2);this.canny=null;if(this.doCannyPruning)this.canny=z(this,this.img);this.scale=d;this.min_neighbors=j;this.scale_inc=e;this.increment=a;this.ready=!1;if(this.Parallel){for(a=[];d<=this.maxScale;d*=e)a.push({haardata:this.haardata,width:this.width,height:this.height,ratio:this.ratio,gray:this.gray,img:this.img,squares:this.squares,doCannyPruning:this.doCannyPruning,canny:this.canny,maxScale:this.maxScale,min_neighbors:this.min_neighbors,
scale_inc:this.scale_inc,increment:this.increment,scale:d});(new this.Parallel(a)).require(r,v,w,t,u).map(t).reduce(u).then(function(a){f.objects=s(f,a,f.min_neighbors);f.ready=!0;f.async&&f.onComplete&&f.onComplete.call(f)})}else this._timeinterval=setInterval(function(){var a=f.haardata.size1,c=f.width,e=f.height,d,b,i;if(f.scale<=f.maxScale){d=Math.floor(f.scale*a*f.increment);for(var a=Math.floor(f.scale*a),j=0,o=c-a;j<o;j+=d)for(var n=0,p=e-a;n<p;n+=d){if(f.doCannyPruning&&(b=j+(n+a)*c,i=j+n*
c,b=f.canny[b+a]+f.canny[i]-f.canny[b]-f.canny[i+a],b=b/a/a,b<20||b>100))continue;b=!0;i=0;for(var q=f.haardata.stages.length;i<q;i++)if(b=r(f,i,j,n,f.scale),b==!1)break;b&&f.ret.push({x:j,y:n,width:a,height:a})}f.scale*=f.scale_inc}else clearInterval(f._timeinterval),f.objects=s(f,f.ret,f.min_neighbors),f.ready=!0,f.async&&f.onComplete&&f.onComplete.call(f)},this._interval);return this}}})(this);
