/**
*
* HAAR.js Feature Detection Library based on Viola-Jones Haar Detection algorithm
* Port of jviolajones (Java) which is a port of openCV C++ Haar Detector
*
* Supports parallel "map-reduce" computation both in browser and nodejs using parallel.js library 
* https://github.com/adambom/parallel.js (included)
*
* version: 0.3.1
* https://github.com/foo123/HAAR.js
*
*
* @contributor Nikos M.  (http://nikos-web-development.netai.net/)
* @contributor maxired (https://github.com/maxired)
*
**/
(function(o){function z(b){var f=b.getContext("2d").getImageData(0,0,b.width,b.height),b=f.width,i=f.height,f=f.data,c,g,a,h,d,j;c=b*i;var k=new A(c),e=new p(c),l=new p(c);for(a=0;a<b;a++)for(h=g=c=0;h<i;h++)ind=h*b+a,d=ind*4,red=f[d],green=f[d+1],blue=f[d+2],d=0.3*red+0.59*green+0.11*blue,j=d*d,c+=d,g+=j,k[ind]=d,e[ind]=(a>0?e[a-1+h*b]:0)+c,l[ind]=(a>0?l[a-1+h*b]:0)+g;return{img:k,gray:e,squares:l}}function B(b,f,i){var c,g,a,h,d,j,k;c=f*i;var e=new p(c),l=new p(c);for(c=2;c<f-2;c++)for(g=2;g<i-
2;g++)d=g*f,h=d+f,j=h+f,ind_1=d-f,k=ind_1-f,a=0,a+=2*b[c-2+k],a+=4*b[c-2+ind_1],a+=5*b[c-2+d],a+=4*b[c-2+h],a+=2*b[c-2+j],a+=4*b[c-1+k],a+=9*b[c-1+ind_1],a+=12*b[c-1+d],a+=9*b[c-1+h],a+=4*b[c-1+j],a+=5*b[c+0+k],a+=12*b[c+0+ind_1],a+=15*b[c+0+d],a+=12*b[c+0+h],a+=5*b[c+0+j],a+=4*b[c+1+k],a+=9*b[c+1+ind_1],a+=12*b[c+1+d],a+=9*b[c+1+h],a+=4*b[c+1+j],a+=2*b[c+2+k],a+=4*b[c+2+ind_1],a+=5*b[c+2+d],a+=4*b[c+2+h],a+=2*b[c+2+j],e[c+d]=a*0.0062893081761006;for(c=1;c<f-1;c++)for(g=1;g<i-1;g++)d=g*f,h=d+f,ind_1=
d-f,b=-e[c-1+ind_1]+e[c+1+ind_1]-2*e[c-1+d]+2*e[c+1+d]-e[c-1+h]+e[c+1+h],h=e[c-1+ind_1]+2*e[c+ind_1]+e[c+1+ind_1]-e[c-1+h]-2*e[c+h]-e[c+1+h],l[c+d]=Math.abs(b)+Math.abs(h);for(c=0;c<f;c++)for(g=b=0;g<i;g++)d=g*f,h=l[c+d],b+=h,e[c+d]=(c>0?e[c-1+d]:0)+b;return e}function u(b){var f=b.scale,i=b.haardata.size1,c=[],g=b.width,a=b.height,h,d,j,k,e,l,m,n;if(f<=b.maxScale){h=Math.floor(f*i*b.increment);i=Math.floor(f*i);k=0;for(l=g-i;k<l;k+=h){e=0;for(m=a-i;e<m;e+=h){if(b.doCannyPruning&&(d=k+(e+i)*g,j=k+
e*g,d=b.canny[d+i]+b.canny[j]-b.canny[d]-b.canny[j+i],d=d/i/i,d<20||d>100))continue;d=!0;j=0;for(n=b.haardata.stages.length;j<n;j++)if(d=s(b,j,k,e,f),d==!1)break;d&&c.push({i:b.i,x:k,y:e,width:i,height:i})}}}return c}function v(b){b[1].length&&(b[0]=b[0].concat(b[1]).sort(function(b,i){return b.i-i.i}));return b[0]}function w(b,f){console.log(f);var i=b.min_neighbors,c=b.Ratio,g=f.length,a=Array(g),h=0,d=[],j=!1,k,e;for(e=0;e<g;e++)a[e]=0;for(e=0;e<g;e++){j=!1;for(k=0;k<e;k++){var l;l=f[k];var m=
f[e],n=Math.max(Math.floor(l.width*0.2),Math.floor(m.width*0.2));l=m.x<=l.x+n&&m.x>=l.x-n&&m.y<=l.y+n&&m.y>=l.y-n&&m.width<=Math.floor(l.width*1.2)&&Math.floor(m.width*1.2)>=l.width?!0:l.x>=m.x&&l.x+l.width<=m.x+m.width&&l.y>=m.y&&l.y+l.height<=m.y+m.height?!0:!1;l&&(j=!0,a[e]=a[k])}j||(a[e]=h,h++)}j=Array(h);k=Array(h);for(e=0;e<h;e++)j[e]=0,k[e]={x:0,y:0,width:0,height:0};for(e=0;e<g;e++)j[a[e]]++,k[a[e]].x+=f[e].x,k[a[e]].y+=f[e].y,k[a[e]].height+=f[e].height,k[a[e]].width+=f[e].width;for(e=0;e<
h;e++)if(a=j[e],a>=i)g={x:0,y:0,width:0,height:0},g.x=(k[e].x*2+a)/(2*a),g.y=(k[e].y*2+a)/(2*a),g.width=(k[e].width*2+a)/(2*a),g.height=(k[e].height*2+a)/(2*a),d.push(g);if(c!=1){c=1/c;for(e=0;e<d.length;e++)i=d[e],d[e]={x:i.x*c,y:i.y*c,width:i.width*c,height:i.height*c}}b.objects=d;b.Ready=!0;b.Async&&b.onComplete&&b.onComplete.call(b)}function s(b,f,i,c,g){var a=0,h=b.haardata.stages[f].thres,d,j=b.haardata.stages[f].trees.length;for(d=0;d<j;d++)a+=x(b,f,d,i,c,g);return a>h}function x(b,f,i,c,g,
a){for(var h=b.haardata.stages[f].trees[i].feats,d=0,j=h[d];;)if(y(b,f,i,d,c,g,a)==0)if(j.has_l)return j.l_val;else d=j.l_node,j=h[d];else if(j.has_r)return j.r_val;else d=j.r_node,j=h[d]}function y(b,f,i,c,g,a,h){for(var d=Math.floor(h*b.haardata.size1),j=Math.floor(h*b.haardata.size2),k=b.width,e=1/(d*j),l=a*k,m=(a+j)*k,j=b.gray,n=b.squares,r=(j[g+d+m]+j[g+l]-j[g+m]-j[g+d+l])*e,d=(n[g+d+m]+n[g+l]-n[g+m]-n[g+d+l])*e-r*r,i=b.haardata.stages[f].trees[i].feats[c],b=i.rects,f=b.length,i=i.thres,c=0,
t,q,d=d>1?Math.sqrt(d):1,l=0;l<f;l++)m=b[l],n=g+Math.floor(h*m.x1),r=g+Math.floor(h*(m.x1+m.y1)),t=a+Math.floor(h*m.x2),q=a+Math.floor(h*(m.x2+m.y2)),c+=Math.floor((j[r+q*k]-j[n+q*k]-j[r+t*k]+j[n+t*k])*m.f);return c*e<i*d?0:1}var o="undefined"!=typeof module&&module.exports?module.exports:"undefined"!=typeof exports?exports:o.HAAR={},A=typeof Float32Array!=="undefined"?Float32Array:Array,p=typeof Float64Array!=="undefined"?Float64Array:Array;o.Detector=function(b,f){this.haardata=b;this.Async=!0;
this.doCannyPruning=this.Ready=!1;this.TimeInterval=this.ret=this.Canvas=null;this.DetectInterval=30;this.Ratio=0.5;this.Parallel=f||!1;this.onComplete=null};o.Detector.prototype={image:function(b,f,i){if(b)this.Canvas=i||document.createElement("canvas"),this.Ratio=typeof f=="undefined"?0.5:f,this.Async=!0,this.Ready=!1,this.width=this.Canvas.width=Math.floor(this.Ratio*b.width),this.height=this.Canvas.height=Math.floor(this.Ratio*b.height),this.Canvas.getContext("2d").drawImage(b,0,0,b.width,b.height,
0,0,this.Canvas.width,this.Canvas.height);return this},interval:function(b){if(b>0)this.DetectInterval=b;return this},complete:function(b){this.onComplete=b;return this},detect:function(b,f,i,c,g){var a=this,h=a.haardata.size1,d=a.haardata.size2;a.doCannyPruning=typeof g=="undefined"?!0:g;g=z(a.Canvas);a.gray=g.gray;a.squares=g.squares;a.canny=a.doCannyPruning?B(g.img,a.width,a.height):null;g=null;a.maxScale=Math.min(a.width/h,a.height/d);a.scale=b;a.min_neighbors=c;a.scale_inc=f;a.increment=i;a.Ready=
!1;if(a.Parallel){h=[];for(d=0;b<=a.maxScale;b*=f)h.push({haardata:a.haardata,width:a.width,height:a.height,gray:a.gray,squares:a.squares,doCannyPruning:a.doCannyPruning,canny:a.canny,maxScale:a.maxScale,min_neighbors:c,scale_inc:f,increment:i,scale:b,i:d++});(new a.Parallel(h)).require(s,x,y,u,v).map(u).reduce(v).then(function(b){w(a,b)})}else a.ret=[],a.TimeInterval=setInterval(function(){var b=a.haardata.size1,c=a.width,e=a.height,d,f,g,h,i,q,o,p;if(a.scale<=a.maxScale){d=Math.floor(a.scale*b*
a.increment);b=Math.floor(a.scale*b);h=0;for(q=c-b;h<q;h+=d){i=0;for(o=e-b;i<o;i+=d){if(a.doCannyPruning&&(f=h+(i+b)*c,g=h+i*c,f=a.canny[f+b]+a.canny[g]-a.canny[f]-a.canny[g+b],f=f/b/b,f<20||f>100))continue;f=!0;g=0;for(p=a.haardata.stages.length;g<p;g++)if(f=s(a,g,h,i,a.scale),f==!1)break;f&&a.ret.push({x:h,y:i,width:b,height:b})}}a.scale*=a.scale_inc}else clearInterval(a.TimeInterval),w(a,a.ret)},a.DetectInterval);return this}}})(this);
