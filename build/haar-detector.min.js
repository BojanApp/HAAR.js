/**
*
* HAAR.js Feature Detection Library based on Viola-Jones Haar Detection algorithm
* Port of jviolajones (Java) which is a port of openCV C++ Haar Detector
*
* Supports parallel "map-reduce" computation both in browser and nodejs (using parallel.js library)
*
* version: 0.3
* https://github.com/foo123/HAAR.js
*
*
* @contributor Nikos M.  (http://nikos-web-development.netai.net/)
* @contributor maxired (https://github.com/maxired)
*
**/
(function(p){function z(e,f){var a=f.getContext("2d").getImageData(0,0,f.width,f.height),i=a.width,d=a.height,b,k,c,g,h,l,a=a.data;b=i*d;var j=new A(b);e.width=i;e.height=d;e.gray=new q(b);e.squares=new q(b);for(c=0;c<i;c++)for(g=k=b=0;g<d;g++)ind=g*i+c,h=ind*4,red=a[h],green=a[h+1],blue=a[h+2],h=0.3*red+0.59*green+0.11*blue,l=h*h,b+=h,k+=l,j[ind]=h,e.gray[ind]=(c>0?e.gray[c-1+g*i]:0)+b,e.squares[ind]=(c>0?e.squares[c-1+g*i]:0)+k;return j}function B(e,f){var a,i,d,b=e.width,k=e.height,c,g,h,l;a=b*
k;var j=new q(a),m=new q(a);for(a=2;a<b-2;a++)for(i=2;i<k-2;i++)g=i*b,c=g+b,h=c+b,ind_1=g-b,l=ind_1-b,d=0,d+=2*f[a-2+l],d+=4*f[a-2+ind_1],d+=5*f[a-2+g],d+=4*f[a-2+c],d+=2*f[a-2+h],d+=4*f[a-1+l],d+=9*f[a-1+ind_1],d+=12*f[a-1+g],d+=9*f[a-1+c],d+=4*f[a-1+h],d+=5*f[a+0+l],d+=12*f[a+0+ind_1],d+=15*f[a+0+g],d+=12*f[a+0+c],d+=5*f[a+0+h],d+=4*f[a+1+l],d+=9*f[a+1+ind_1],d+=12*f[a+1+g],d+=9*f[a+1+c],d+=4*f[a+1+h],d+=2*f[a+2+l],d+=4*f[a+2+ind_1],d+=5*f[a+2+g],d+=4*f[a+2+c],d+=2*f[a+2+h],j[a+g]=d/159;for(a=1;a<
b-1;a++)for(i=1;i<k-1;i++)g=i*b,c=g+b,ind_1=g-b,d=-j[a-1+ind_1]+j[a+1+ind_1]-2*j[a-1+g]+2*j[a+1+g]-j[a-1+c]+j[a+1+c],c=j[a-1+ind_1]+2*j[a+ind_1]+j[a+1+ind_1]-j[a-1+c]-2*j[a+c]-j[a+1+c],m[a+g]=Math.abs(d)+Math.abs(c);for(a=0;a<b;a++)for(i=c=0;i<k;i++)g=i*b,d=m[a+g],c+=d,j[a+g]=(a>0?j[a-1+g]:0)+c;return j}function u(e,f,a){for(var i=f.length,d=Array(i),b=0,k=[],c=!1,g,h,c=0;c<i;c++)d[c]=0;for(h=0;h<i;h++){c=!1;for(g=0;g<h;g++){var l;l=f[g];var j=f[h],m=Math.max(Math.floor(l.width*0.2),Math.floor(j.width*
0.2));l=j.x<=l.x+m&&j.x>=l.x-m&&j.y<=l.y+m&&j.y>=l.y-m&&j.width<=Math.floor(l.width*1.2)&&Math.floor(j.width*1.2)>=l.width?!0:l.x>=j.x&&l.x+l.width<=j.x+j.width&&l.y>=j.y&&l.y+l.height<=j.y+j.height?!0:!1;l&&(c=!0,d[h]=d[g])}c||(d[h]=b,b++)}i=Array(b);g=Array(b);for(h=0;h<b;h++)i[h]=0,g[h]={x:0,y:0,width:0,height:0};for(h=0;h<f.length;h++)i[d[h]]++,g[d[h]].x+=f[h].x,g[d[h]].y+=f[h].y,g[d[h]].height+=f[h].height,g[d[h]].width+=f[h].width;for(h=0;h<b;h++)if(f=i[h],f>=a)c={x:0,y:0,width:0,height:0},
c.x=(g[h].x*2+f)/(2*f),c.y=(g[h].y*2+f)/(2*f),c.width=(g[h].width*2+f)/(2*f),c.height=(g[h].height*2+f)/(2*f),k.push(c);if(e.ratio!=1){a=1/e.ratio;for(h=0;h<k.length;h++)e=k[h],k[h]={x:e.x*a,y:e.y*a,width:e.width*a,height:e.height*a}}return k}function v(e){var f=e.scale,a=e.haardata.size1,i=[],d=e.width,b=e.height,k,c,g,h,l,j,m,n;if(f<=e.maxScale){k=Math.floor(f*a*e.increment);a=Math.floor(f*a);h=0;for(j=d-a;h<j;h+=k){l=0;for(m=b-a;l<m;l+=k){if(e.doCannyPruning&&(c=h+(l+a)*d,g=h+l*d,c=e.canny[c+a]+
e.canny[g]-e.canny[c]-e.canny[g+a],c=c/a/a,c<20||c>100))continue;c=!0;g=0;for(n=e.haardata.stages.length;g<n;g++)if(c=t(e,g,h,l,f),c==!1)break;c&&i.push({i:e.i,x:h,y:l,width:a,height:a})}}}return i}function w(e){e[1].length&&(e[0]=e[0].concat(e[1]).sort(function(e,a){return e.i-a.i}));return e[0]}function t(e,f,a,i,d){var b=0,k=e.haardata.stages[f].thres,c,g=e.haardata.stages[f].trees.length;for(c=0;c<g;c++)b+=x(e,f,c,a,i,d);return b>k}function x(e,f,a,i,d,b){for(var k=e.haardata.stages[f].trees[a].feats,
c=0,g=k[c];;)if(y(e,f,a,c,i,d,b)==0)if(g.has_l)return g.l_val;else c=g.l_node,g=k[c];else if(g.has_r)return g.r_val;else c=g.r_node,g=k[c]}function y(e,f,a,i,d,b,k){for(var c=Math.floor(k*e.haardata.size1),g=Math.floor(k*e.haardata.size2),h=e.width,l=1/(c*g),j=b*h,m=(b+g)*h,g=e.gray,n=e.squares,r=(g[d+c+m]+g[d+j]-g[d+m]-g[d+c+j])*l,c=(n[d+c+m]+n[d+j]-n[d+m]-n[d+c+j])*l-r*r,a=e.haardata.stages[f].trees[a].feats[i],e=a.rects,f=e.length,a=a.thres,c=c>1?Math.sqrt(c):1,j=i=0;j<f;j++){var m=e[j],n=d+Math.floor(k*
m.x1),r=d+Math.floor(k*(m.x1+m.y1)),o=b+Math.floor(k*m.x2),s=b+Math.floor(k*(m.x2+m.y2));i+=Math.floor((g[r+s*h]-g[n+s*h]-g[r+o*h]+g[n+o*h])*m.f)}return i*l<a*c?0:1}var p="undefined"!=typeof module&&module.exports?module.exports:"undefined"!=typeof exports?exports:p.HAAR={},A=typeof Float32Array!=="undefined"?Float32Array:Array,q=typeof Float64Array!=="undefined"?Float64Array:Array;p.Detector=function(e,f){this.haardata=e;this.async=!0;this.ready=!1;this.canvas=null;this._interval=30;this.Parallel=
f||!1;this.onComplete=null};p.Detector.prototype={image:function(e,f,a){if(e)this.canvas=a||document.createElement("canvas"),this.ratio=typeof f=="undefined"?0.5:f,this.async=!0,this.ready=!1,this.canvas.width=this.ratio*e.width,this.canvas.height=this.ratio*e.height,this.canvas.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,this.canvas.width,this.canvas.height);return this},interval:function(e){if(e>0)this._interval=e;return this},complete:function(e){this.onComplete=e;return this},detect:function(e,
f,a,i,d){var b=this,k=b.haardata.size1,c=b.haardata.size2;b.doCannyPruning=typeof d=="undefined"?!0:d;d=z(b,b.canvas);b.canny=b.doCannyPruning?B(b,d):null;d=null;b.maxScale=Math.min(b.width/k,b.height/c);b.scale=e;b.min_neighbors=i;b.scale_inc=f;b.increment=a;b.ready=!1;if(b.Parallel){k=[];for(c=0;e<=b.maxScale;e*=f)k.push({haardata:b.haardata,width:b.width,height:b.height,gray:b.gray,squares:b.squares,doCannyPruning:b.doCannyPruning,canny:b.canny,maxScale:b.maxScale,min_neighbors:i,scale_inc:f,increment:a,
scale:e,i:c++});(new b.Parallel(k)).require(t,x,y,v,w).map(v).reduce(w).then(function(a){b.objects=u(b,a,b.min_neighbors);b.ready=!0;b.async&&b.onComplete&&b.onComplete.call(b)})}else b.ret=[],b._timeinterval=setInterval(function(){var a=b.haardata.size1,c=b.width,e=b.height,f,d,i,k,o,s,p,q;if(b.scale<=b.maxScale){f=Math.floor(b.scale*a*b.increment);a=Math.floor(b.scale*a);k=0;for(s=c-a;k<s;k+=f){o=0;for(p=e-a;o<p;o+=f){if(b.doCannyPruning&&(d=k+(o+a)*c,i=k+o*c,d=b.canny[d+a]+b.canny[i]-b.canny[d]-
b.canny[i+a],d=d/a/a,d<20||d>100))continue;d=!0;i=0;for(q=b.haardata.stages.length;i<q;i++)if(d=t(b,i,k,o,b.scale),d==!1)break;d&&b.ret.push({x:k,y:o,width:a,height:a})}}b.scale*=b.scale_inc}else clearInterval(b._timeinterval),b.objects=u(b,b.ret,b.min_neighbors),b.ready=!0,b.async&&b.onComplete&&b.onComplete.call(b)},b._interval);return this}}})(this);
