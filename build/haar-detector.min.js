/**
*
* HAAR.js Feature Detection Library based on Viola-Jones Haar Detection algorithm
* port of jViolaJones  for Java (http://code.google.com/p/jviolajones/) to JavaScript and Node
*
* https://github.com/foo123/HAAR.js
* @version: 0.4.3
*
* Supports parallel "map-reduce" computation both in browser and node using parallel.js library 
* https://github.com/adambom/parallel.js (included)
*
**/(function(){function t(t){var i,e,n,h,a,s,r,o=t.getContext("2d").getImageData(0,0,t.width,t.height),l=o.width,d=o.height,c=o.data,u=l*d,y=c.length,w=new g(u),x=new f(u),m=new f(u),p=new f(u);for(h=0,n=0,i=e=0;l>h;)r=4899*c[n]+9617*c[n+1]+1868*c[n+2]+8192>>>14,r&=255,i+=r,e+=(4294967295&r*r)>>>0,w[h]=r,x[h]=i,m[h]=e,p[h]=r,h++,n+=4;for(a=0,s=1,h=l,n=l<<2,i=e=0;y>n;)r=4899*c[n]+9617*c[n+1]+1868*c[n+2]+8192>>>14,r&=255,i+=r,e+=(4294967295&r*r)>>>0,w[h]=r,x[h]=x[h-l]+i,m[h]=m[h-l]+e,p[h]=p[h+1-l]+(r+w[h-l])+(s>1?p[h-l-l]:0)+(a>0?p[h-1-l]:0),a++,h++,n+=4,a>=l&&(a=0,s++,i=e=0);return{gray:w,integral:x,squares:m,tilted:p}}function i(t,i,e){var n,h,a,s,r,o,l,d,c,u,w,x=t.length,m=new g(x),p=new f(x);for(n=0;i>n;n++)m[n]=0,m[n+i]=0,m[n+x-i]=0,m[n+x-i-i]=0,p[n]=0,p[n+x-i]=0;for(h=0,a=0;e>h;h++,a+=i)m[0+a]=0,m[1+a]=0,m[i-1+a]=0,m[i-2+a]=0,p[0+a]=0,p[i-1+a]=0;for(n=2;i-2>n;n++)for(s=0,h=2,a=i<<1;e-2>h;h++,a+=i)l=n+a,d=l+i,c=d+i,u=l-i,w=u-i,s=(4294967295&0+(t[w-2]<<1)+(t[u-2]<<2)+(t[l-2]<<2)+t[l-2]+(t[d-2]<<2)+(t[c-2]<<1)+(t[w-1]<<2)+(t[u-1]<<3)+t[u-1]+(t[l-1]<<4)-(t[l-1]<<2)+(t[d-1]<<3)+t[d-1]+(t[c-1]<<2)+(t[w]<<2)+t[w]+(t[u]<<4)-(t[u]<<2)+(t[l]<<4)-t[l]+(t[d]<<4)-(t[d]<<2)+(t[c]<<2)+t[c]+(t[w+1]<<2)+(t[u+1]<<3)+t[u+1]+(t[l+1]<<4)-(t[l+1]<<2)+(t[d+1]<<3)+t[d+1]+(t[c+1]<<2)+(t[w+2]<<1)+(t[u+2]<<2)+(t[l+2]<<2)+t[l+2]+(t[d+2]<<2)+(t[c+2]<<1))>>>0,m[l]=(255&(4294967295&103*s+8192)>>>14)>>>0;for(n=1;i-1>n;n++)for(h=1,a=i;e-1>h;h++,a+=i)l=a+n,d=l+i,u=l-i,r=0-m[u-1]+m[u+1]-m[l-1]-m[l-1]+m[l+1]+m[l+1]-m[d-1]+m[d+1],o=0+m[u-1]+m[u]+m[u]+m[u+1]-m[d-1]-m[d]-m[d]-m[d+1],p[l]=4294967295&y(r)+y(o);for(n=0,s=0;i>n;)s+=p[n],p[n]=4294967295&s,n++;for(n=i,a=0,s=0;x>n;)s+=p[n],p[n]=4294967295&p[n-i]+s,n++,a++,a>=i&&(a=0,s=0);return p}function e(t,i,e){var h,a,s,r,o,l,d,u=t.length,g=new Array(u),f=[],y=0,w=!1;for(s=0;u>s;s++)g[s]=0;for(s=0;u>s;s++){for(w=!1,r=0;s>r;r++)t[r].almostEqual(t[s])&&(w=!0,g[s]=g[r]);w||(g[s]=y,y++)}for(h=new Array(y),a=new Array(y),s=0;y>s;s++)h[s]=0,a[s]=new c;for(s=0;u>s;s++)d=g[s],h[d]++,a[d].add(t[s]);for(s=0;y>s;s++)o=h[s],o>=i&&(l=1/(o+o),d=new c(l*(2*a[s].x+o),l*(2*a[s].y+o),l*(2*a[s].width+o),l*(2*a[s].height+o)),f.push(d));for(1!=e&&(e=1/e),u=f.length,s=0;u>s;s++)for(r=s+1;u>r;r++)!f[s].isInside&&f[s].inside(f[r])?f[s].isInside=!0:!f[r].isInside&&f[r].inside(f[s])&&(f[r].isInside=!0);for(s=u;--s>=0;)f[s].isInside?f.splice(s,1):(1!=e&&f[s].scale(e),f[s].round().computeArea());return f.sort(n)}function n(t,i){return t.area-i.area}function h(t,i){return t.index-i.index}function a(t){return t[1].length&&(t[0]=t[0].concat(t[1]).sort(h)),t[0]}function r(t){var i,e,n,h,a,r,o,l,d,c,u,g,f,y,w,x,m,p,v,S,I,C,_,q,A,R,b,P,H,T,D,M,L,j,z,E,U,W,k,O,F,N,V,B,G,J,K,Q,X,Y=Y||Math.sqrt,Z=[],$=t.haardata,ti=t.scaledSelection,ii=ti.width,ei=ti.height,ni=ii*ei,hi=ni-1,ai=$.size1,si=$.size2,ri=ti.x,oi=ti.y,li=$.stages.length,di=t.cannyLow,ci=t.cannyHigh,ui=t.canny,gi=t.integral,fi=t.squares,yi=t.tilted,wi=t.scale,xi=t.increment,mi=t.i||0,pi=t.doCannyPruning;for(w=0,x=ii-1,m=0,p=ni-ii,n=~~(wi*ai),i=~~(n*xi),h=~~(wi*si),e=~~(h*xi),d=h*ii,c=e*ii,a=oi*c,xl=ii-n,yl=ei-h,v=n*h,S=1/v,o=oi,l=a;yl>o;o+=e,l+=c)for(r=ri;xl>r;r+=i)if(u=r-1+l-ii,g=u+n,f=u+d,y=f+n,u=0>u?0:u>hi?hi:u,g=0>g?0:g>hi?hi:g,f=0>f?0:f>hi?hi:f,y=0>y?0:y>hi?hi:y,!(pi&&(q=S*(ui[y]-ui[f]-ui[g]+ui[u]),di>q||q>ci))){for(I=S*(gi[y]-gi[f]-gi[g]+gi[u]),C=S*(fi[y]-fi[f]-fi[g]+fi[u]),_=C-I*I,_=_>1?Y(_):1,A=!0,s=0;li>s;s++){for(R=$.stages[s],b=R.thres,P=R.trees,H=P.length,X=0,T=0;H>T;T++)for(L=P[T].feats,D=0;;){if(j=L[D],z=j.rects,E=z.length,U=j.thres,W=0,j.tilt)for(k=0;E>k;k++)O=z[k],F=r+~~(wi*O[0]),N=(o-1+~~(wi*O[1]))*ii,V=r+~~(wi*(O[0]+O[2])),B=(o-1+~~(wi*(O[1]+O[2])))*ii,G=r+~~(wi*(O[0]-O[3])),J=(o-1+~~(wi*(O[1]+O[3])))*ii,K=r+~~(wi*(O[0]+O[2]-O[3])),Q=(o-1+~~(wi*(O[1]+O[2]+O[3])))*ii,F=w>F?w:F>x?x:F,V=w>V?w:V>x?x:V,G=w>G?w:G>x?x:G,K=w>K?w:K>x?x:K,N=m>N?m:N>p?p:N,B=m>B?m:B>p?p:B,J=m>J?m:J>p?p:J,Q=m>Q?m:Q>p?p:Q,W+=O[4]*(yi[K+Q]-yi[G+J]-yi[V+B]+yi[F+N]);else for(k=0;E>k;k++)O=z[k],F=r-1+~~(wi*O[0]),V=r-1+~~(wi*(O[0]+O[2])),N=ii*(o-1+~~(wi*O[1])),B=ii*(o-1+~~(wi*(O[1]+O[3]))),F=w>F?w:F>x?x:F,V=w>V?w:V>x?x:V,N=m>N?m:N>p?p:N,B=m>B?m:B>p?p:B,W+=O[4]*(gi[V+B]-gi[F+B]-gi[V+N]+gi[F+N]);if(M=U*_>W*S?0:1){if(j.has_r){X+=j.r_val;break}D=j.r_node}else{if(j.has_l){X+=j.l_val;break}D=j.l_node}}if(A=X>b?!0:!1,!A)break}A&&Z.push({index:mi,x:r,y:o,width:n,height:h})}return Z}function o(t,i){for(var n=0,h=i.length;h>n;n++)i[n]=new c(i[n]);t.objects=e(i,t.min_neighbors,t.Ratio,t.Selection),t.Ready=!0,t.onComplete&&t.onComplete.call(t)}var l,d,c,u="0.4.3";l="undefined"!=typeof module&&module.exports?module.exports:"undefined"!=typeof exports?exports:this.HAAR={},l.VERSION=u;var g="undefined"!=typeof Uint8Array?Uint8Array:Array,f="undefined"!=typeof Uint32Array?Uint32Array:Array,y=Math.abs,w=Math.max,x=Math.min,m=(Math.floor,Math.round),p=(Math.sqrt,Array.prototype.slice);d=l.Detector=function(t,i){this.haardata=t,this.Ready=!1,this.doCannyPruning=!1,this.Canvas=null,this.Selection=null,this.scaledSelection=null,this.objects=null,this.TimeInterval=null,this.DetectInterval=30,this.Ratio=.5,this.cannyLow=20,this.cannyHigh=100,this.Parallel=i||!1,this.onComplete=null},d.prototype={constructor:d,haardata:null,Canvas:null,objects:null,Selection:null,scaledSelection:null,Ratio:.5,origWidth:0,origHeight:0,width:0,height:0,DetectInterval:30,TimeInterval:null,doCannyPruning:!1,cannyLow:20,cannyHigh:100,canny:null,integral:null,squares:null,tilted:null,Parallel:!1,Ready:!1,onComplete:null,clearCache:function(){return this.haardata=null,this.canny=null,this.integral=null,this.squares=null,this.tilted=null,this},cascade:function(t){return this.haardata=t,this},image:function(e,n,h){if(e){this.Canvas||(this.Canvas=h||document.createElement("canvas")),this.Ratio="undefined"==typeof n?.5:n,this.Ready=!1,this.origWidth=e.width,this.origHeight=e.height,this.width=this.Canvas.width=m(this.Ratio*e.width),this.height=this.Canvas.height=m(this.Ratio*e.height),this.Canvas.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,this.width,this.height);var a=t(this.Canvas);this.canny=i(a.gray,this.width,this.height),this.integral=a.integral,this.squares=a.squares,this.tilted=a.tilted,a=null}return this},interval:function(t){return t>0&&(this.DetectInterval=t),this},cannyThreshold:function(t){return t&&"undefined"!=typeof t.low&&(this.cannyLow=t.low),t&&"undefined"!=typeof t.high&&(this.cannyHigh=t.high),this},selection:function(){var t=p.call(arguments),i=t.length;return this.Selection=1==i&&"auto"==t[0]||!i?null:c.prototype.data.apply(new c,t),this},complete:function(t){return this.onComplete=t,this},detect:function(t,i,e,n,s){var l=this,d=l.haardata.size1,u=l.haardata.size2;if(l.Selection||(l.Selection=new c(0,0,l.origWidth,l.origHeight)),l.Selection.x="auto"==l.Selection.x?0:l.Selection.x,l.Selection.y="auto"==l.Selection.y?0:l.Selection.y,l.Selection.width="auto"==l.Selection.width?l.origWidth:l.Selection.width,l.Selection.height="auto"==l.Selection.height?l.origHeight:l.Selection.height,l.scaledSelection=l.Selection.clone().scale(l.Ratio).round(),t="undefined"==typeof t?1:t,i="undefined"==typeof i?1.25:i,e="undefined"==typeof e?.5:e,n="undefined"==typeof n?1:n,l.doCannyPruning="undefined"==typeof s?!0:s,l.maxScale=x(l.width/d,l.height/u),l.scale=t,l.min_neighbors=n,l.scale_inc=i,l.increment=e,l.Ready=!1,l.Parallel&&l.Parallel.isSupported()){var g,f=[],y=0;for(g=t;g<=l.maxScale;g*=l.scale_inc)f.push({haardata:l.haardata,width:l.width,height:l.height,scaledSelection:{x:l.scaledSelection.x,y:l.scaledSelection.y,width:l.scaledSelection.width,height:l.scaledSelection.height},integral:l.integral,squares:l.squares,tilted:l.tilted,doCannyPruning:l.doCannyPruning,canny:l.doCannyPruning?l.canny:null,cannyLow:l.cannyLow,cannyHigh:l.cannyHigh,maxScale:l.maxScale,min_neighbors:l.min_neighbors,scale_inc:l.scale_inc,increment:l.increment,scale:g,i:y++});new l.Parallel(f,{synchronous:!1}).require(h,r,a).map(r).reduce(a).then(function(t){o(l,t)})}else{var w=[],m=function(){l.scale<=l.maxScale?(w=w.concat(r(l)),l.scale*=l.scale_inc,l.TimeInterval=setTimeout(m,l.DetectInterval)):(clearTimeout(l.TimeInterval),o(l,w))};l.TimeInterval=setTimeout(m,l.DetectInterval)}return this}},c=l.Feature=function(t,i,e,n,h){this.data(t,i,e,n,h)},c.prototype={constructor:c,index:0,x:0,y:0,width:0,height:0,area:0,isInside:!1,data:function(t,i,e,n,h){return t&&t instanceof c?this.copy(t):t&&t instanceof Object?(this.x=t.x||0,this.y=t.y||0,this.width=t.width||0,this.height=t.height||0,this.index=t.index||0,this.area=t.area||0,this.isInside=t.isInside||!1):(this.x=t||0,this.y=i||0,this.width=e||0,this.height=n||0,this.index=h||0,this.area=0,this.isInside=!1),this},add:function(t){return this.x+=t.x,this.y+=t.y,this.width+=t.width,this.height+=t.height,this},scale:function(t){return this.x*=t,this.y*=t,this.width*=t,this.height*=t,this},round:function(){return this.x=~~(this.x+.5),this.y=~~(this.y+.5),this.width=~~(this.width+.5),this.height=~~(this.height+.5),this},computeArea:function(){return this.area=this.width*this.height,this.area},inside:function(t){return this.x>=t.x&&this.y>=t.y&&this.x+this.width<=t.x+t.width&&this.y+this.height<=t.y+t.height?!0:!1},contains:function(t){return t.inside(this)},equal:function(t){return t.x==this.x&&t.y==this.y&&t.width==this.width&&t.height==this.height?!0:!1},almostEqual:function(t){var i=.2*w(t.width,this.width),e=.2*w(t.height,this.height);return y(this.x-t.x)<=i&&y(this.y-t.y)<=e&&y(this.width-t.width)<=i&&y(this.height-t.height)<=e?!0:!1},clone:function(){var t=new c;return t.x=this.x,t.y=this.y,t.width=this.width,t.height=this.height,t.index=this.index,t.area=this.area,t.isInside=this.isInside,t},copy:function(t){return t&&t instanceof c&&(this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.index=t.index,this.area=t.area,this.isInside=t.isInside),this},toString:function(){return"[ x: "+this.x+", y: "+this.y+", width: "+this.width+", height: "+this.height+" ]"}}}).call(this);