/**
*
* HAAR.js Feature Detection Library based on Viola-Jones Haar Detection algorithm
* Port of jviolajones (Java) which is a port of openCV C++ Haar Detector
*
* Supports parallel "map-reduce" computation both in browser and nodejs using parallel.js library 
* https://github.com/adambom/parallel.js (included)
*
* version: 0.3.1
* https://github.com/foo123/HAAR.js
*
*
* @contributor Nikos M.  (http://nikos-web-development.netai.net/)
* @contributor maxired (https://github.com/maxired)
*
**/
(function(o){function z(a){var f=a.getContext("2d").getImageData(0,0,a.width,a.height),a=f.width,i=f.height,f=f.data,c,g,b,h,d,j;c=a*i;var k=new A(c),e=new p(c),l=new p(c);for(b=0;b<a;b++)for(h=g=c=0;h<i;h++)ind=h*a+b,d=ind*4,red=f[d],green=f[d+1],blue=f[d+2],d=0.3*red+0.59*green+0.11*blue,j=d*d,c+=d,g+=j,k[ind]=d,e[ind]=(b>0?e[b-1+h*a]:0)+c,l[ind]=(b>0?l[b-1+h*a]:0)+g;return{img:k,gray:e,squares:l}}function B(a,f,i){var c,g,b,h,d,j,k;c=f*i;var e=new p(c),l=new p(c);for(c=2;c<f-2;c++)for(g=2;g<i-
2;g++)d=g*f,h=d+f,j=h+f,ind_1=d-f,k=ind_1-f,b=0,b+=2*a[c-2+k],b+=4*a[c-2+ind_1],b+=5*a[c-2+d],b+=4*a[c-2+h],b+=2*a[c-2+j],b+=4*a[c-1+k],b+=9*a[c-1+ind_1],b+=12*a[c-1+d],b+=9*a[c-1+h],b+=4*a[c-1+j],b+=5*a[c+0+k],b+=12*a[c+0+ind_1],b+=15*a[c+0+d],b+=12*a[c+0+h],b+=5*a[c+0+j],b+=4*a[c+1+k],b+=9*a[c+1+ind_1],b+=12*a[c+1+d],b+=9*a[c+1+h],b+=4*a[c+1+j],b+=2*a[c+2+k],b+=4*a[c+2+ind_1],b+=5*a[c+2+d],b+=4*a[c+2+h],b+=2*a[c+2+j],e[c+d]=b*0.0062893081761006;for(c=1;c<f-1;c++)for(g=1;g<i-1;g++)d=g*f,h=d+f,ind_1=
d-f,a=-e[c-1+ind_1]+e[c+1+ind_1]-2*e[c-1+d]+2*e[c+1+d]-e[c-1+h]+e[c+1+h],h=e[c-1+ind_1]+2*e[c+ind_1]+e[c+1+ind_1]-e[c-1+h]-2*e[c+h]-e[c+1+h],l[c+d]=Math.abs(a)+Math.abs(h);for(c=0;c<f;c++)for(g=a=0;g<i;g++)d=g*f,h=l[c+d],a+=h,e[c+d]=(c>0?e[c-1+d]:0)+a;return e}function u(a){var f=a.scale,i=a.haardata.size1,c=[],g=a.width,b=a.height,h,d,j,k,e,l,m,n;if(f<=a.maxScale){h=Math.floor(f*i*a.increment);i=Math.floor(f*i);k=0;for(l=g-i;k<l;k+=h){e=0;for(m=b-i;e<m;e+=h){if(a.doCannyPruning&&(d=k+(e+i)*g,j=k+
e*g,d=a.canny[d+i]+a.canny[j]-a.canny[d]-a.canny[j+i],d=d/i/i,d<20||d>100))continue;d=!0;j=0;for(n=a.haardata.stages.length;j<n;j++)if(d=s(a,j,k,e,f),d==!1)break;d&&c.push({i:a.i,x:k,y:e,width:i,height:i})}}}return c}function v(a){a[1].length&&(a[0]=a[0].concat(a[1]).sort(function(a,i){return a.i-i.i}));return a[0]}function w(a,f){console.log(f);var i=a.min_neighbors,c=a.Ratio,g=f.length,b=Array(g),h=0,d=[],j=!1,k,e;for(e=0;e<g;e++)b[e]=0;for(e=0;e<g;e++){j=!1;for(k=0;k<e;k++){var l;l=f[k];var m=
f[e],n=Math.max(Math.floor(l.width*0.2),Math.floor(m.width*0.2));l=m.x<=l.x+n&&m.x>=l.x-n&&m.y<=l.y+n&&m.y>=l.y-n&&m.width<=Math.floor(l.width*1.2)&&Math.floor(m.width*1.2)>=l.width?!0:l.x>=m.x&&l.x+l.width<=m.x+m.width&&l.y>=m.y&&l.y+l.height<=m.y+m.height?!0:!1;l&&(j=!0,b[e]=b[k])}j||(b[e]=h,h++)}j=Array(h);k=Array(h);for(e=0;e<h;e++)j[e]=0,k[e]={x:0,y:0,width:0,height:0};for(e=0;e<g;e++)j[b[e]]++,k[b[e]].x+=f[e].x,k[b[e]].y+=f[e].y,k[b[e]].height+=f[e].height,k[b[e]].width+=f[e].width;for(e=0;e<
h;e++)if(b=j[e],b>=i)g={x:0,y:0,width:0,height:0},g.x=(k[e].x*2+b)/(2*b),g.y=(k[e].y*2+b)/(2*b),g.width=(k[e].width*2+b)/(2*b),g.height=(k[e].height*2+b)/(2*b),d.push(g);if(c!=1){c=1/c;for(e=0;e<d.length;e++)i=d[e],d[e]={x:i.x*c,y:i.y*c,width:i.width*c,height:i.height*c}}a.objects=d;a.Ready=!0;a.Async&&a.onComplete&&a.onComplete.call(a)}function s(a,f,i,c,g){var b=0,h=a.haardata.stages[f].thres,d,j=a.haardata.stages[f].trees.length;for(d=0;d<j;d++)b+=x(a,f,d,i,c,g);return b>h}function x(a,f,i,c,g,
b){for(var h=a.haardata.stages[f].trees[i].feats,d=0,j=h[d];;)if(y(a,f,i,d,c,g,b)==0)if(j.has_l)return j.l_val;else d=j.l_node,j=h[d];else if(j.has_r)return j.r_val;else d=j.r_node,j=h[d]}function y(a,f,i,c,g,b,h){for(var d=Math.floor(h*a.haardata.size1),j=Math.floor(h*a.haardata.size2),k=a.width,e=1/(d*j),l=b*k,m=(b+j)*k,j=a.gray,n=a.squares,r=(j[g+d+m]+j[g+l]-j[g+m]-j[g+d+l])*e,d=(n[g+d+m]+n[g+l]-n[g+m]-n[g+d+l])*e-r*r,i=a.haardata.stages[f].trees[i].feats[c],a=i.rects,f=a.length,i=i.thres,c=0,
t,q,d=d>1?Math.sqrt(d):1,l=0;l<f;l++)m=a[l],n=g+Math.floor(h*m.x1),r=g+Math.floor(h*(m.x1+m.y1)),t=b+Math.floor(h*m.x2),q=b+Math.floor(h*(m.x2+m.y2)),c+=Math.floor((j[r+q*k]-j[n+q*k]-j[r+t*k]+j[n+t*k])*m.f);return c*e<i*d?0:1}var o="undefined"!=typeof module&&module.exports?module.exports:"undefined"!=typeof exports?exports:o.HAAR={},A=typeof Float32Array!=="undefined"?Float32Array:Array,p=typeof Float64Array!=="undefined"?Float64Array:Array;o.Detector=function(a,f){this.haardata=a;this.Async=!0;
this.doCannyPruning=this.Ready=!1;this.TimeInterval=this.ret=this.Canvas=null;this.DetectInterval=30;this.Ratio=0.5;this.Parallel=f||!1;this.onComplete=null};o.Detector.prototype={image:function(a,f,i){if(a)this.Canvas=i||document.createElement("canvas"),this.Ratio=typeof f=="undefined"?0.5:f,this.Async=!0,this.Ready=!1,this.width=this.Canvas.width=Math.floor(this.Ratio*a.width),this.height=this.Canvas.height=Math.floor(this.Ratio*a.height),this.Canvas.getContext("2d").drawImage(a,0,0,a.width,a.height,
0,0,this.Canvas.width,this.Canvas.height);return this},interval:function(a){if(a>0)this.DetectInterval=a;return this},complete:function(a){this.onComplete=a;return this},detect:function(a,f,i,c,g){var b=this,h=b.haardata.size1,d=b.haardata.size2,a=typeof a=="undefined"?1:a,f=typeof f=="undefined"?1.25:f,i=typeof i=="undefined"?0.1:i,c=typeof c=="undefined"?1:c;b.doCannyPruning=typeof g=="undefined"?!0:g;g=z(b.Canvas);b.gray=g.gray;b.squares=g.squares;b.canny=b.doCannyPruning?B(g.img,b.width,b.height):
null;g=null;b.maxScale=Math.min(b.width/h,b.height/d);b.scale=a;b.min_neighbors=c;b.scale_inc=f;b.increment=i;b.Ready=!1;if(b.Parallel&&b.Parallel.isSupported()){h=[];for(d=0;a<=b.maxScale;a*=f)h.push({haardata:b.haardata,width:b.width,height:b.height,gray:b.gray,squares:b.squares,doCannyPruning:b.doCannyPruning,canny:b.canny,maxScale:b.maxScale,min_neighbors:c,scale_inc:f,increment:i,scale:a,i:d++});(new b.Parallel(h,{synchronous:!1})).require(s,x,y,u,v).map(u).reduce(v).then(function(a){w(b,a)})}else b.ret=
[],b.TimeInterval=setInterval(function(){var a=b.haardata.size1,c=b.width,e=b.height,d,f,g,h,i,q,o,p;if(b.scale<=b.maxScale){d=Math.floor(b.scale*a*b.increment);a=Math.floor(b.scale*a);h=0;for(q=c-a;h<q;h+=d){i=0;for(o=e-a;i<o;i+=d){if(b.doCannyPruning&&(f=h+(i+a)*c,g=h+i*c,f=b.canny[f+a]+b.canny[g]-b.canny[f]-b.canny[g+a],f=f/a/a,f<20||f>100))continue;f=!0;g=0;for(p=b.haardata.stages.length;g<p;g++)if(f=s(b,g,h,i,b.scale),f==!1)break;f&&b.ret.push({x:h,y:i,width:a,height:a})}}b.scale*=b.scale_inc}else clearInterval(b.TimeInterval),
w(b,b.ret)},b.DetectInterval);return this}}})(this);
