/**
*
* HAAR.js Feature Detection Library based on Viola-Jones Haar Detection algorithm
* port of jViolaJones  for Java (http://code.google.com/p/jviolajones/) to JavaScript and Node
*
* https://github.com/foo123/HAAR.js
* @version: 0.4.4
*
* Supports parallel "map-reduce" computation both in browser and node using parallel.js library 
* https://github.com/adambom/parallel.js (included)
*
**/!function(t,i,e){"object"==typeof module&&module.exports?module.exports=e():"function"==typeof define&&define.amd?define(e):t[i]=e()}(this,"HAAR",function(){function t(t,i,e){var n,h,a,s,r,o,l,c=t.length,d=i*e,g=new f(d),y=new u(d),w=new u(d),x=new u(d);for(s=0,a=0,n=h=0;i>s;)l=4899*t[a]+9617*t[a+1]+1868*t[a+2]+8192>>>14,l&=255,n+=l,h+=l*l,g[s]=l,y[s]=n,w[s]=h,x[s]=l,s++,a+=4;for(r=0,o=1,s=i,a=i<<2,n=h=0;c>a;)l=4899*t[a]+9617*t[a+1]+1868*t[a+2]+8192>>>14,l&=255,n+=l,h+=l*l,g[s]=l,y[s]=y[s-i]+n,w[s]=w[s-i]+h,x[s]=x[s+1-i]+(l+g[s-i])+(o>1?x[s-i-i]:0)+(r>0?x[s-1-i]:0),r++,s++,a+=4,r>=i&&(r=0,o++,n=h=0);return{gray:g,integral:y,squares:w,tilted:x}}function i(t,i,e){var n,h,a,s,r,o,l,c,d,y,w,x=t.length,m=new f(x),p=new u(x);for(n=0;i>n;n++)m[n]=0,m[n+i]=0,m[n+x-i]=0,m[n+x-i-i]=0,p[n]=0,p[n+x-i]=0;for(h=0,a=0;e>h;h++,a+=i)m[0+a]=0,m[1+a]=0,m[i-1+a]=0,m[i-2+a]=0,p[0+a]=0,p[i-1+a]=0;for(n=2;i-2>n;n++)for(s=0,h=2,a=i<<1;e-2>h;h++,a+=i)l=n+a,c=l+i,d=c+i,y=l-i,w=y-i,s=0+(t[w-2]<<1)+(t[y-2]<<2)+(t[l-2]<<2)+t[l-2]+(t[c-2]<<2)+(t[d-2]<<1)+(t[w-1]<<2)+(t[y-1]<<3)+t[y-1]+(t[l-1]<<4)-(t[l-1]<<2)+(t[c-1]<<3)+t[c-1]+(t[d-1]<<2)+(t[w]<<2)+t[w]+(t[y]<<4)-(t[y]<<2)+(t[l]<<4)-t[l]+(t[c]<<4)-(t[c]<<2)+(t[d]<<2)+t[d]+(t[w+1]<<2)+(t[y+1]<<3)+t[y+1]+(t[l+1]<<4)-(t[l+1]<<2)+(t[c+1]<<3)+t[c+1]+(t[d+1]<<2)+(t[w+2]<<1)+(t[y+2]<<2)+(t[l+2]<<2)+t[l+2]+(t[c+2]<<2)+(t[d+2]<<1),m[l]=(255&(4294967295&103*s+8192)>>>14)>>>0;for(n=1;i-1>n;n++)for(h=1,a=i;e-1>h;h++,a+=i)l=a+n,c=l+i,y=l-i,r=0-m[y-1]+m[y+1]-m[l-1]-m[l-1]+m[l+1]+m[l+1]-m[c-1]+m[c+1],o=0+m[y-1]+m[y]+m[y]+m[y+1]-m[c-1]-m[c]-m[c]-m[c+1],p[l]=g(r)+g(o);for(n=0,s=0;i>n;)s+=p[n],p[n]=s,n++;for(n=i,a=0,s=0;x>n;)s+=p[n],p[n]=p[n-i]+s,n++,a++,a>=i&&(a=0,s=0);return p}function e(t,i,e){var h,a,s,r,o,l,d,u=t.length,f=new Array(u),g=[],y=0,w=!1;for(s=0;u>s;s++)f[s]=0;for(s=0;u>s;s++){for(w=!1,r=0;s>r;r++)t[r].almostEqual(t[s])&&(w=!0,f[s]=f[r]);w||(f[s]=y,y++)}for(h=new Array(y),a=new Array(y),s=0;y>s;s++)h[s]=0,a[s]=new c;for(s=0;u>s;s++)d=f[s],h[d]++,a[d].add(t[s]);for(s=0;y>s;s++)o=h[s],o>=i&&(l=1/(o+o),d=new c(l*(2*a[s].x+o),l*(2*a[s].y+o),l*(2*a[s].width+o),l*(2*a[s].height+o)),g.push(d));for(1!=e&&(e=1/e),u=g.length,s=0;u>s;s++)for(r=s+1;u>r;r++)!g[s].isInside&&g[s].inside(g[r])?g[s].isInside=!0:!g[r].isInside&&g[r].inside(g[s])&&(g[r].isInside=!0);for(s=u;--s>=0;)g[s].isInside?g.splice(s,1):(1!=e&&g[s].scale(e),g[s].round().computeArea());return g.sort(n)}function n(t,i){return t.area-i.area}function h(t,i){return t.index-i.index}function a(t){return t[1].length&&(t[0]=t[0].concat(t[1]).sort(h)),t[0]}function r(t){var i,e,n,h,a,r,o,l,c,d,u,f,g,y,w,x,m,p,v,S,I,C,q,_,A,H,b,P,R,T,M,L,D,E,j,W,z,k,F,V,O,U,N,B,G,J,K,Q,X,Y=Y||Math.sqrt,Z=[],$=t.haardata,ti=t.scaledSelection,ii=ti.width,ei=ti.height,ni=ii*ei,hi=ni-1,ai=$.size1,si=$.size2,ri=ti.x,oi=ti.y,li=$.stages.length,ci=t.cannyLow,di=t.cannyHigh,ui=t.canny,fi=t.integral,gi=t.squares,yi=t.tilted,wi=t.scale,xi=t.increment,mi=t.i||0,pi=t.doCannyPruning;for(w=0,x=ii-1,m=0,p=ni-ii,n=~~(wi*ai),i=~~(n*xi),h=~~(wi*si),e=~~(h*xi),c=h*ii,d=e*ii,a=oi*d,xl=ii-n,yl=ei-h,v=n*h,S=1/v,o=oi,l=a;yl>o;o+=e,l+=d)for(r=ri;xl>r;r+=i)if(u=r-1+l-ii,f=u+n,g=u+c,y=g+n,u=0>u?0:u>hi?hi:u,f=0>f?0:f>hi?hi:f,g=0>g?0:g>hi?hi:g,y=0>y?0:y>hi?hi:y,!(pi&&(_=S*(ui[y]-ui[g]-ui[f]+ui[u]),ci>_||_>di))){for(I=S*(fi[y]-fi[g]-fi[f]+fi[u]),C=S*(gi[y]-gi[g]-gi[f]+gi[u]),q=C-I*I,q=q>1?Y(q):1,A=!0,s=0;li>s;s++){for(H=$.stages[s],b=H.thres,P=H.trees,R=P.length,X=0,T=0;R>T;T++)for(D=P[T].feats,M=0;;){if(E=D[M],j=E.rects,W=j.length,z=E.thres,k=0,E.tilt)for(F=0;W>F;F++)V=j[F],O=r+~~(wi*V[0]),U=(o-1+~~(wi*V[1]))*ii,N=r+~~(wi*(V[0]+V[2])),B=(o-1+~~(wi*(V[1]+V[2])))*ii,G=r+~~(wi*(V[0]-V[3])),J=(o-1+~~(wi*(V[1]+V[3])))*ii,K=r+~~(wi*(V[0]+V[2]-V[3])),Q=(o-1+~~(wi*(V[1]+V[2]+V[3])))*ii,O=w>O?w:O>x?x:O,N=w>N?w:N>x?x:N,G=w>G?w:G>x?x:G,K=w>K?w:K>x?x:K,U=m>U?m:U>p?p:U,B=m>B?m:B>p?p:B,J=m>J?m:J>p?p:J,Q=m>Q?m:Q>p?p:Q,k+=V[4]*(yi[K+Q]-yi[G+J]-yi[N+B]+yi[O+U]);else for(F=0;W>F;F++)V=j[F],O=r-1+~~(wi*V[0]),N=r-1+~~(wi*(V[0]+V[2])),U=ii*(o-1+~~(wi*V[1])),B=ii*(o-1+~~(wi*(V[1]+V[3]))),O=w>O?w:O>x?x:O,N=w>N?w:N>x?x:N,U=m>U?m:U>p?p:U,B=m>B?m:B>p?p:B,k+=V[4]*(fi[N+B]-fi[O+B]-fi[N+U]+fi[O+U]);if(L=z*q>k*S?0:1){if(E.has_r){X+=E.r_val;break}M=E.r_node}else{if(E.has_l){X+=E.l_val;break}M=E.l_node}}if(A=X>b?!0:!1,!A)break}A&&Z.push({index:mi,x:r,y:o,width:n,height:h})}return Z}function o(t,i){for(var n=0,h=i.length;h>n;n++)i[n]=new c(i[n]);t.objects=e(i,t.min_neighbors,t.Ratio,t.Selection),t.Ready=!0,t.onComplete&&t.onComplete.call(t)}var l,c,d={VERSION:"0.4.4"},u="undefined"!=typeof Float32Array?Float32Array:Array,f="undefined"!=typeof Uint8Array?Uint8Array:Array,g=Math.abs,y=Math.max,w=Math.min,x=(Math.floor,Math.round),m=(Math.sqrt,Array.prototype.slice);return l=d.Detector=function(t,i){this.haardata=t,this.Ready=!1,this.doCannyPruning=!1,this.Canvas=null,this.Selection=null,this.scaledSelection=null,this.objects=null,this.TimeInterval=null,this.DetectInterval=30,this.Ratio=.5,this.cannyLow=20,this.cannyHigh=100,this.Parallel=i||!1,this.onComplete=null},l.prototype={constructor:l,haardata:null,Canvas:null,objects:null,Selection:null,scaledSelection:null,Ratio:.5,origWidth:0,origHeight:0,width:0,height:0,DetectInterval:30,TimeInterval:null,doCannyPruning:!1,cannyLow:20,cannyHigh:100,canny:null,integral:null,squares:null,tilted:null,Parallel:!1,Ready:!1,onComplete:null,clearCache:function(){return this.haardata=null,this.canny=null,this.integral=null,this.squares=null,this.tilted=null,this},cascade:function(t){return this.haardata=t,this},image:function(e,n,h){if(e){var a,s,r,o,l,c,d,u;this.Canvas||(this.Canvas=h||document.createElement("canvas")),u=this.Ratio="undefined"==typeof n?.5:n,this.Ready=!1,o=this.origWidth=e instanceof HTMLVideoElement?e.videoWidth:e.width,l=this.origHeight=e instanceof HTMLVideoElement?e.videoHeight:e.height,c=this.width=this.Canvas.width=x(u*o),d=this.height=this.Canvas.height=x(u*l),a=this.Canvas.getContext("2d"),a.drawImage(e,0,0,o,l,0,0,c,d),s=a.getImageData(0,0,c,d),r=t(s.data,s.width,s.height),this.integral=r.integral,this.squares=r.squares,this.tilted=r.tilted,this.canny=i(r.gray,c,d),r.gray=null,r.integral=null,r.squares=null,r.tilted=null,r=null}return this},interval:function(t){return t>0&&(this.DetectInterval=t),this},cannyThreshold:function(t){return t&&"undefined"!=typeof t.low&&(this.cannyLow=t.low),t&&"undefined"!=typeof t.high&&(this.cannyHigh=t.high),this},selection:function(){var t=m.call(arguments),i=t.length;return this.Selection=1==i&&"auto"==t[0]||!i?null:c.prototype.data.apply(new c,t),this},complete:function(t){return this.onComplete=t,this},detect:function(t,i,e,n,s){var l=this,d=l.haardata.size1,u=l.haardata.size2;if(l.Selection||(l.Selection=new c(0,0,l.origWidth,l.origHeight)),l.Selection.x="auto"==l.Selection.x?0:l.Selection.x,l.Selection.y="auto"==l.Selection.y?0:l.Selection.y,l.Selection.width="auto"==l.Selection.width?l.origWidth:l.Selection.width,l.Selection.height="auto"==l.Selection.height?l.origHeight:l.Selection.height,l.scaledSelection=l.Selection.clone().scale(l.Ratio).round(),t="undefined"==typeof t?1:t,i="undefined"==typeof i?1.25:i,e="undefined"==typeof e?.5:e,n="undefined"==typeof n?1:n,l.doCannyPruning="undefined"==typeof s?!0:s,l.maxScale=w(l.width/d,l.height/u),l.scale=t,l.min_neighbors=n,l.scale_inc=i,l.increment=e,l.Ready=!1,l.Parallel&&l.Parallel.isSupported()){var f,g=[],y=0;for(f=t;f<=l.maxScale;f*=l.scale_inc)g.push({haardata:l.haardata,width:l.width,height:l.height,scaledSelection:{x:l.scaledSelection.x,y:l.scaledSelection.y,width:l.scaledSelection.width,height:l.scaledSelection.height},integral:l.integral,squares:l.squares,tilted:l.tilted,doCannyPruning:l.doCannyPruning,canny:l.doCannyPruning?l.canny:null,cannyLow:l.cannyLow,cannyHigh:l.cannyHigh,maxScale:l.maxScale,min_neighbors:l.min_neighbors,scale_inc:l.scale_inc,increment:l.increment,scale:f,i:y++});new l.Parallel(g,{synchronous:!1}).require(h,r,a).map(r).reduce(a).then(function(t){o(l,t)})}else{var x=[],m=function(){l.scale<=l.maxScale?(x=x.concat(r(l)),l.scale*=l.scale_inc,l.TimeInterval=setTimeout(m,l.DetectInterval)):(clearTimeout(l.TimeInterval),o(l,x))};l.TimeInterval=setTimeout(m,l.DetectInterval)}return this}},c=d.Feature=function(t,i,e,n,h){this.data(t,i,e,n,h)},c.prototype={constructor:c,index:0,x:0,y:0,width:0,height:0,area:0,isInside:!1,data:function(t,i,e,n,h){return t&&t instanceof c?this.copy(t):t&&t instanceof Object?(this.x=t.x||0,this.y=t.y||0,this.width=t.width||0,this.height=t.height||0,this.index=t.index||0,this.area=t.area||0,this.isInside=t.isInside||!1):(this.x=t||0,this.y=i||0,this.width=e||0,this.height=n||0,this.index=h||0,this.area=0,this.isInside=!1),this},add:function(t){return this.x+=t.x,this.y+=t.y,this.width+=t.width,this.height+=t.height,this},scale:function(t){return this.x*=t,this.y*=t,this.width*=t,this.height*=t,this},round:function(){return this.x=~~(this.x+.5),this.y=~~(this.y+.5),this.width=~~(this.width+.5),this.height=~~(this.height+.5),this},computeArea:function(){return this.area=this.width*this.height,this.area},inside:function(t){return this.x>=t.x&&this.y>=t.y&&this.x+this.width<=t.x+t.width&&this.y+this.height<=t.y+t.height?!0:!1},contains:function(t){return t.inside(this)},equal:function(t){return t.x==this.x&&t.y==this.y&&t.width==this.width&&t.height==this.height?!0:!1},almostEqual:function(t){var i=.2*y(t.width,this.width),e=.2*y(t.height,this.height);return g(this.x-t.x)<=i&&g(this.y-t.y)<=e&&g(this.width-t.width)<=i&&g(this.height-t.height)<=e?!0:!1},clone:function(){var t=new c;return t.x=this.x,t.y=this.y,t.width=this.width,t.height=this.height,t.index=this.index,t.area=this.area,t.isInside=this.isInside,t},copy:function(t){return t&&t instanceof c&&(this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.index=t.index,this.area=t.area,this.isInside=t.isInside),this},toString:function(){return"[ x: "+this.x+", y: "+this.y+", width: "+this.width+", height: "+this.height+" ]"}},d});