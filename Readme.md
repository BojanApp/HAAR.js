# HAAR.js 

__Feature Detection Library for javascript__  (uses HTML5 canvas on browser and Canvas package on Node.js)

Based on [Viola-Jones Feature Detection Algorithm using Haar Cascades](http://www.cs.cmu.edu/~efros/courses/LBMV07/Papers/viola-cvpr-01.pdf)

This is a port of [OpenCV C++ Haar Detection](http://opencv.willowgarage.com/wiki/) (actually a port of [JViolaJones](http://code.google.com/p/jviolajones/) which is a port of OpenCV for Java) to javascript and HTML5 canvas.

[![Haar.js Face Detection](/examples/haar-face-detection.png)](http://foo123.github.com/examples/face-detection/)
[![Haar.js Many Faces Detection](/examples/haar-faces-detection.png)](http://foo123.github.com/examples/face-detection/)
[![Haar.js Face Detection](/examples/haar-mouth-detection.png)](http://foo123.github.com/examples/face-detection/)

###Contents

* [Live Examples](#live-example)
* [How to Use](#how-to-use)
* [Haar Cascades](#where-to-find-haar-cascades-xml-files-to-use-for-feature-detection)
* [Usage Ideas](#usage-ideas)
* [Todo](#todo)
* [Changelog](#changelog)

###Live Example
* [Face Detection](http://foo123.github.com/examples/face-detection/)


###How To use
You can use the __existing openCV cascades__ to build your detectors.

To do this just transform the opencv xml file to javascript
using the haartojs (php ~~or java~~) tool (in cascades folder)

example:
( to use opencv's haarcascades_frontalface_alt.xml  run following command)
```bash
haartojs haarcascades_frontalface_alt
```

this creates a javascript file:   
*haarcascades_frontalface_alt.js*
which you can include in your html file or node file

the variable to use in javascript is similarly  
*haarcascades_frontalface_alt*

####Detector Methods

__constructor()__
```javascript
new detector(haardata, Parallel);
```

__Explanation of parameters__

* _haardata_ : The actual haardata (as generated by haartojs tool), this is specific per feature, openCV haar data can be used.
* _Parallel_ : Optional, this is the _Parallel_ object, as returned by the _parallel.js_ script (included). It enables HAAR.js to run parallel computations both in browser and nodejs (much faster)

__image()__
```javascript
detector.image(ImageOrVideoOrCanvas, scale, CanvasClass);
```

__Explanation of parameters__

* _ImageOrVideoOrCanvas_ : an actual Image or Video element or Canvas Object (in this case they are equivalent).
* _scale_ : The percent of scaling from the original image, so detection proceeds faster on a smaller image (default __0.5__ ). __NOTE__ scaling might alter the detection results sometimes, if having problems opt towards 1 (slower)
* _CanvasClass_ : This is optional and used only when running in nodejs (passing the node-canvas object).


__interval()__
```javascript
detector.interval(detectionInterval);
```

__Explanation of parameters__

* _detectionInterval_ : interval to run the detection asynchronously (if not parallel) in  microseconds (default __30__).


__selection()__
```javascript
detector.selection('auto'|object|feature|x [,y, width, height]);
```

Allow to set a custom region in the image to confine the detection process only in that region (eg detect nose while face already detected)

__Explanation of parameters__

* _1st parameter_ : This can be the string 'auto' which sets the whole image as the selection, or an object ie: {x:10, y:'auto', width:100, height:'auto'} (every param set as 'auto' will take the default image value) or a detection rectangle/feature, or a x coordinate (along with rest coordinates).
* _y_ : (Optional) the selection start y coordinate, can be an actual value or 'auto' (y=0)
* _width_ : (Optional) the selection width, can be an actual value or 'auto' (width=image.width)
* _height_ : (Optional) the selection height, can be an actual value or 'auto' (height=image.height)

The actual selection rectangle/feature is available as this.Selection or detector.Selection

__cannyThreshold()__
```javascript
detector.cannyThreshold({low: lowThreshold, high: highThreshold});
```

Set the thresholds when Canny Pruning is used, for extra fine-tuning. 
Canny Pruning detects the number/density of edges in a given region. A region with too few or too many edges is unlikely to be a feature. 
Default values work fine in most cases, however depending on image size and the specific feature, some fine tuning could be needed

__Explanation of parameters__

* _low_ : (Optional) The low threshold (default __20__ ).
* _high_ : (Optional) The high threshold (default __100__ ).


__detect()__
```javascript
detector.detect(baseScale, scale_inc, increment, min_neighbors, doCannyPruning);
```

__Explanation of parameters__ ([JViolaJones Parameters](http://code.google.com/p/jviolajones/wiki/Parameters))

* _baseScale_ : The initial ratio between the window size and the Haar classifier size (default __1__ ).
* _scale_inc_ : The scale increment of the window size, at each step (default __1.25__ ).
* _increment_ : The shift of the window at each sub-step, in terms of percentage of the window size (default __0.1__ ).
* _min_neighbors_ : The minimum numbers of similar rectangles needed for the region to be considered as a feature (avoid noise) (default __1__ )
* _doCannyPruning_ : enable Canny Pruning to pre-detect regions unlikely to contain features, in order to speed up the execution (optional default __true__ ). 

__HAAR.js works in the browser and inside Node.js (supports parallel computations both in browser and node)__


####Runing inside the brower
 Loading wth script tags
    You can run the example face.html or mouth.html inside your browser

####Running inside Node
 For running, the package have a dependency on canvas
 You can find an example inside examples/nodes.js
Valid Output
```bash
node examples/node.js 
processing the picture
[{"x":102.5,"y":105.5,"width":160.66666666666666,"height":160.66666666666666}]
```

To work properly, canvas need some system depencencies.
You can find instruction on https://github.com/LearnBoost/node-canvas/wiki
For example for Ubuntu : 
```bash
sudo apt-get install libcairo2-dev libjpeg8-dev libpango1.0-dev libgif-dev
```

####Loading with RequireJS
 As a third option, you can load the library with requireJS, both on the browser on with node.
There is an example of loading with RequireJS inside node in examples/require.js.
The configuration would be the same inside a browser

####Supporting parallel computation
 The [parallel.js](https://github.com/adambom/parallel.js) library is included in this repository, see the _face.html_ example for how to use.
 In most cases using parallel computation (if supported) can be much faster (eg _eye.html_ example)


###Where to find Haar Cascades xml files to use for feature detection
* [OpenCV](http://opencv.org/)
* [This resource](http://alereimondo.no-ip.org/OpenCV/34)
* search the web :)
* [Train your own](http://docs.opencv.org/doc/user_guide/ug_traincascade.html) with a little extra help [here](http://note.sonots.com/SciSoftware/haartraining.html) and [here](http://coding-robin.de/2013/07/22/train-your-own-opencv-haar-classifier.html)
* A [haarcascade for eyes](http://www-personal.umich.edu/~shameem/haarcascade_eye.html) contributed by [Mar Canet](https://github.com/mcanet) demo [here](/examples/eye.html)



###Usage Ideas
* [SmileDetectJS](https://github.com/roironn/SmileDetectJS)
* [ObjectDetect](https://github.com/mtschirs/js-objectdetect) (some common ideas with HAAR.js are used with extra functionality like object tracking)



###TODO
-[x] optimize detector for real-time usage on browsers (eg. reference-> https://github.com/liuliu/ccv) [DONE, parallel.js]
-[x] add selection option, detection is confined to that selection (eg detect nose while face already detected) [DONE]
-[x] check if some operations can use fixed-point arithmetic, or other micro-optimizations (will try) [DONE where applicable]
-[ ] keep up with the changes in openCV cascades xml format (will try)
-[ ] add some real performance tests (anyone interested??)



###ChangeLog

__0.4__
* add selection option to confine detection to a specific image region 
* add fine-tuning for canny pruning thresholds
* refactor/optimize merge method (filter features/rectangles that are inside other features), detection features may be slightly different now
* reduce unnecessary loops/computations from java port (now it is more javascript-esque or in some cases even asm-esque)
* implement fixed-point arithmetic where applicable (gray-scaling, canny computation, references included)
* optimize array indexing (remove unnecessary multiplications use only additions/subtractions)
* features are now custom classes with own methods (much easier to handle while backwards-compatible)
* partial code refactoring / minor fixes
* add more examples (eg many faces detection, tilted faces detection)
* update Readme

__0.3.1__
* fix ordering issue when using parallel computations (rectangles merged in random order)
* fix dimensions computation when scale <> 1 (floating point numbers can give errors)
* minor refactoring, optimizations

__0.3__
* support optional parallel computation/detection (browser and nodejs) using [parallel.js](https://github.com/adambom/parallel.js) library (included)
* refactoring of code

__0.2.1__
* use TypedArrays if available for faster array operations
* minor index/number optimizations

__0.2__
* add haartojs tool in php (in cascades folder)
* haartojs produces a javascript file using closures (fixes previous issue with the java tool)

__0.1.1__
* customization to work with Node.js and require.js by [maxired](https://github.com/maxired)  (using js closures) 

__0.1__
* initial commit by [Nikos M.](https://github.com/foo123) (works on browser)


*URL* [Nikos Web Development](http://nikos-web-development.netai.net/ "Nikos Web Development")  
*URL* [Haar.js blog post](http://nikos-web-development.netai.net/blog/haar-js-feature-detection-in-javascript-and-html5-canvas/ "Haar.js blog post")  
*URL* [WorkingClassCode](http://workingclasscode.uphero.com/ "Working Class Code")  
